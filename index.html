<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inzu</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-512.png">
    <link rel="apple-touch-icon" href="icon-512.png">
    <meta name="theme-color" content="#A64456">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: white;
            min-height: 100vh;
            color: #0D0D0D;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            position: relative;
        }

        .app-header {
            background: white;
            color: #0D0D0D;
            padding: 20px 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #A64456;
        }

        .app-header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .app-header p {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        /* Header brand layout and logo */
        .app-header .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-menu {
            position: relative;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #A64456;
            border: 2px solid rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            margin: 8px;
        }

        .user-avatar:hover {
            background: #8B3646;
            transform: scale(1.05);
        }

        .user-avatar svg {
            width: 24px;
            height: 24px;
            fill: white;
        }

        .user-slideout {
            position: fixed;
            top: 0;
            right: -300px;
            width: 300px;
            height: 100%;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            z-index: 1001;
            transition: right 0.3s ease-out;
            display: flex;
            flex-direction: column;
        }

        .user-slideout.active {
            right: 0;
        }

        .slideout-header {
            background: #A64456;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .slideout-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .slideout-close:hover {
            background: rgba(255,255,255,0.2);
        }

        .slideout-content {
            padding: 20px;
            flex: 1;
        }

        .user-info {
            text-align: center;
            margin-bottom: 30px;
        }

        .user-avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #A64456;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-avatar-large svg {
            width: 48px;
            height: 48px;
            fill: white;
        }

        .user-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #0D0D0D;
            margin-bottom: 5px;
        }

        .user-email {
            font-size: 0.9rem;
            color: #64748b;
        }

        .slideout-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .slideout-menu li {
            margin-bottom: 5px;
        }

        .slideout-menu button {
            width: 100%;
            background: none;
            border: none;
            padding: 15px 20px;
            text-align: left;
            font-size: 1rem;
            color: #0D0D0D;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .slideout-menu button:hover {
            background: rgba(166, 68, 86, 0.1);
        }

        .slideout-menu button.logout {
            color: #A64456;
            font-weight: 600;
        }

        .slideout-menu button.logout:hover {
            background: rgba(166, 68, 86, 0.15);
        }

        .slideout-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .slideout-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .app-logo {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: contain;
            background: white;
            margin: 4px;
        }

        .splash-logo {
            width: 120px;
            height: 120px;
            margin-bottom: 30px;
            border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: pulse 2s infinite;
            background: white;
            object-fit: contain;
            padding: 8px;
        }

        .tab-navigation {
            display: flex;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .tab-navigation::-webkit-scrollbar {
            display: none;
        }

        .tab-button {
            flex: 1;
            min-width: 120px;
            padding: 16px 12px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 0.875rem;
            font-weight: 500;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab-button.active {
            color: #A64456;
            border-bottom-color: #A64456;
            background: rgba(166, 68, 86, 0.1);
        }

        .tab-button:hover {
            background: #f8fafc;
        }

        .content-area {
            padding: 16px;
            padding-bottom: 80px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .form-card h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: #1e293b;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 6px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s;
            background: white;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #A64456;
            box-shadow: 0 0 0 3px rgba(166, 68, 86, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        .form-actions button {
            flex: 1;
        }
        
        /* Full-screen edit mode - REMOVED - using overlay instead */
        
        /* Tenant Edit Overlay */
        .edit-overlay {
            position: fixed;
            inset: 0;
            background: #ffffff;
            z-index: 3000;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .edit-page {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px 20px 140px;
        }

        .hidden {
            display: none;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-primary {
            background: #A64456;
            color: white;
        }

        .btn-primary:hover {
            background: #8B3646;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(166, 68, 86, 0.3);
        }

        .btn-secondary {
            background: #64748b;
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-full {
            flex: 1;
        }

        .entries-list {
            margin-top: 20px;
        }

        .entry-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .entry-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1e293b;
        }

        .entry-amount {
            font-size: 1.125rem;
            font-weight: 600;
            color: #059669;
        }

        .entry-details {
            font-size: 0.875rem;
            color: #64748b;
            line-height: 1.4;
        }

        .entry-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.875rem;
        }

        .floating-add {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #A64456;
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(166, 68, 86, 0.3);
            z-index: 1000;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .floating-add:hover {
            background: #8B3646;
            transform: scale(1.05);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 1rem;
            margin-bottom: 8px;
        }

        .empty-state-subtext {
            font-size: 0.875rem;
            opacity: 0.7;
        }

        .status-bar {
            background: white;
            border-top: 1px solid #e2e8f0;
            padding: 12px 16px;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 99;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: #64748b;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
        }

        .status-dot.offline {
            background: #ef4444;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .summary-card h4 {
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .summary-amount {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .summary-amount.income {
            color: #10b981;
        }

        .summary-amount.expense {
            color: #ef4444;
        }

        .summary-amount.net {
            color: #1A7363;
        }

        .backup-status {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-label {
            color: #64748b;
            font-size: 0.875rem;
        }

        .status-value {
            color: #1e293b;
            font-weight: 500;
            font-size: 0.875rem;
        }

        @media (min-width: 768px) {
            .summary-cards {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .install-prompt {
            background: white;
            color: #0D0D0D;
            padding: 16px;
            margin: 16px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #A64456;
        }

        .install-prompt h4 {
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .install-prompt p {
            margin-bottom: 12px;
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .auth-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: white;
            padding: 20px;
        }

        .auth-card {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            text-align: center;
        }

        .auth-card h2 {
            color: #1e293b;
            margin-bottom: 12px;
            font-size: 1.875rem;
        }

        .auth-card p {
            color: #64748b;
            margin-bottom: 32px;
            font-size: 0.95rem;
        }

        .google-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            padding: 14px;
            background: white;
            color: #1f2937;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .google-btn:hover {
            border-color: #A64456;
            box-shadow: 0 4px 12px rgba(166, 68, 86, 0.2);
            transform: translateY(-2px);
        }

        .google-icon {
            width: 20px;
            height: 20px;
        }

        /* Collapsible tenant form styles */
        .toggle-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: #A64456;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .collapsible {
            transition: max-height 0.25s ease-in-out, opacity 0.2s ease-in-out;
            overflow: hidden;
        }

        .collapsed {
            max-height: 0 !important;
            opacity: 0;
            padding: 0;
            margin: 0;
        }

        #appContent {
            display: none;
        }


        /* Splash Screen Styles */
        .splash-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: #0D0D0D;
            text-align: center;
            padding: 20px;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }

        .splash-container.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .splash-logo {
            width: 120px;
            height: 120px;
            margin-bottom: 30px;
            border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .splash-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 16px;
            color: #A64456;
            text-shadow: none;
        }

        .splash-subtitle {
            font-size: 1.2rem;
            margin-bottom: 40px;
            opacity: 0.8;
            max-width: 400px;
            line-height: 1.6;
            color: #1A7363;
        }

        .splash-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            max-width: 800px;
            margin: 0 auto 40px;
        }

        .splash-feature {
            background: rgba(166, 68, 86, 0.05);
            border: 1px solid rgba(166, 68, 86, 0.1);
            padding: 20px;
            border-radius: 16px;
        }

        .splash-feature-icon {
            font-size: 2rem;
            margin-bottom: 12px;
            color: #A64456;
        }

        .splash-feature-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: #1A7363;
        }

        .splash-feature-desc {
            font-size: 0.9rem;
            opacity: 0.7;
            line-height: 1.4;
            color: #0D0D0D;
        }

        .splash-get-started {
            background: #BAF266;
            color: #0D0D0D;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .splash-get-started:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(186, 242, 102, 0.4);
        }

        /* Mobile-specific splash screen styles */
        @media (max-width: 767px) {
            .splash-container {
                padding: 15px;
            }
            
            .splash-logo {
                width: 80px;
                height: 80px;
                margin-bottom: 20px;
                border-radius: 16px;
            }
            
            .splash-title {
                font-size: 2rem;
                margin-bottom: 12px;
            }
            
            .splash-subtitle {
                font-size: 1rem;
                margin-bottom: 30px;
                max-width: 320px;
                line-height: 1.5;
            }
            
            .splash-features {
                grid-template-columns: 1fr;
                gap: 16px;
                max-width: 100%;
                margin: 0 auto 30px;
                padding: 0 10px;
            }
            
            .splash-feature {
                padding: 16px;
                border-radius: 12px;
            }
            
            .splash-feature-icon {
                font-size: 1.5rem;
                margin-bottom: 10px;
            }
            
            .splash-feature-title {
                font-size: 1rem;
                margin-bottom: 6px;
            }
            
            .splash-feature-desc {
                font-size: 0.85rem;
                line-height: 1.3;
            }
            
            .splash-get-started {
                padding: 14px 28px;
                font-size: 1rem;
                border-radius: 10px;
                margin: 0 10px;
                max-width: calc(100% - 20px);
            }
        }

        /* Extra small mobile devices */
        @media (max-width: 480px) {
            .splash-container {
                padding: 10px;
            }
            
            .splash-logo {
                width: 70px;
                height: 70px;
                margin-bottom: 15px;
            }
            
            .splash-title {
                font-size: 1.8rem;
            }
            
            .splash-subtitle {
                font-size: 0.9rem;
                margin-bottom: 25px;
                max-width: 280px;
            }
            
            .splash-features {
                gap: 14px;
                margin: 0 auto 25px;
                padding: 0 5px;
            }
            
            .splash-feature {
                padding: 14px;
            }
            
            .splash-feature-icon {
                font-size: 1.3rem;
                margin-bottom: 8px;
            }
            
            .splash-feature-title {
                font-size: 0.95rem;
            }
            
            .splash-feature-desc {
                font-size: 0.8rem;
            }
            
            .splash-get-started {
                padding: 12px 24px;
                font-size: 0.95rem;
                margin: 0 5px;
                max-width: calc(100% - 10px);
            }
        }

        @media (min-width: 768px) {
            .app-container {
                max-width: 768px;
                margin: 20px auto;
                border-radius: 16px;
                overflow: hidden;
                box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            }

            .form-row {
                grid-template-columns: 1fr 1fr 1fr;
            }

            .floating-add {
                bottom: 100px;
            }
        }

        /* Moved out tenant styling */
        .moved-out-tenant {
            opacity: 0.7;
            border-left: 4px solid #ef4444;
            background: #fef2f2;
        }

        .moved-out-stamp {
            background: #ef4444;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: auto;
        }

        /* Property tab styles */
        .units-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .stat-card.occupied {
            border-left: 4px solid #10b981;
        }

        .stat-card.vacant {
            border-left: 4px solid #f59e0b;
        }

        .stat-card.moved-out {
            border-left: 4px solid #ef4444;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
        }

        .units-list h4 {
            margin: 0 0 16px 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
        }

        .unit-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .unit-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .unit-card.moved-out {
            opacity: 0.7;
            background: #fef2f2;
            border-left: 4px solid #ef4444;
        }

        .unit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .unit-number {
            font-weight: 600;
            color: #1f2937;
            font-size: 1rem;
        }

        .unit-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .unit-status.status-occupied {
            background: #10b981;
            color: white;
        }

        .unit-status.status-moved-out {
            background: #ef4444;
            color: white;
        }

        .unit-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .unit-tenant {
            color: #374151;
            font-weight: 500;
        }

        .unit-rent {
            color: #059669;
            font-size: 0.875rem;
        }

        .unit-move-out {
            color: #ef4444;
            font-size: 0.75rem;
            font-style: italic;
        }

        /* Property tab styles */
        .property-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .property-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
            transform: translateY(-2px);
        }

        .property-card.selected {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%);
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.25);
        }

        .property-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .property-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .property-type {
            background: #f3f4f6;
            color: #6b7280;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .selected-badge {
            background: #3b82f6;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .property-details {
            margin-bottom: 16px;
        }

        .property-address {
            color: #6b7280;
            font-size: 0.875rem;
            margin-bottom: 8px;
        }

        .property-stats {
            display: flex;
            gap: 16px;
            margin-bottom: 8px;
        }

        .property-stats .stat {
            background: #f9fafb;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #374151;
        }

        .property-description {
            color: #6b7280;
            font-size: 0.875rem;
            line-height: 1.4;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #f3f4f6;
        }

        .property-actions {
            display: flex;
            gap: 8px;
        }
    </style>
</head>
<body>
    <!-- Splash Screen -->
    <div id="splashContainer" class="splash-container">
        <img src="icon-512.png" alt="Inzu" class="splash-logo">
        <p class="splash-subtitle">Your complete solution for managing rental properties efficiently and professionally</p>
        
        <div class="splash-features">
            <div class="splash-feature">
                <div class="splash-feature-icon">üë•</div>
                <div class="splash-feature-title">Tenant Management</div>
                <div class="splash-feature-desc">Keep track of all your tenants, their details, and rental information in one place</div>
            </div>
            <div class="splash-feature">
                <div class="splash-feature-icon">üí∞</div>
                <div class="splash-feature-title">Payment Tracking</div>
                <div class="splash-feature-desc">Monitor monthly payments, track expenses, and maintain financial records</div>
            </div>
            <div class="splash-feature">
                <div class="splash-feature-icon">üìä</div>
                <div class="splash-feature-title">Smart Reports</div>
                <div class="splash-feature-desc">Generate comprehensive reports and insights about your rental business</div>
            </div>
            <div class="splash-feature">
                <div class="splash-feature-icon">üîí</div>
                <div class="splash-feature-title">Secure & Sync</div>
                <div class="splash-feature-desc">Your data is securely stored and synced across all your devices</div>
            </div>
        </div>
        
        <button class="splash-get-started" onclick="hideSplash()">Get Started</button>
    </div>

    <!-- Auth Container -->
    <div id="authContainer" class="auth-container">
        <div class="auth-card">
            <img src="icon-512.png" alt="Inzu" style="width: 80px; height: 80px; margin-bottom: 20px; border-radius: 16px;">
            <p>Secure access to your rental property data</p>
            <button class="google-btn" onclick="loginWithGoogle()">
                <svg class="google-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path fill="#EA4335" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#4285F4" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Sign in with Google
            </button>
            <p style="margin-top: 20px; font-size: 0.75rem; color: #94a3b8;">
                Your data will be securely saved to your Google account and synced across all your devices.
            </p>
        </div>
    </div>

    <!-- App Content -->
    <div id="appContent">
    <div class="app-container">
        <header class="app-header">
            <div class="brand">
                <img src="icon-512.png" alt="Inzu logo" class="app-logo">
            </div>
            <div class="user-menu">
                <div class="user-avatar" onclick="toggleUserMenu()">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                </div>
            </div>
        </header>

        <!-- User Slideout Panel -->
        <div class="slideout-overlay" onclick="closeUserMenu()"></div>
        <div class="user-slideout">
            <div class="slideout-header">
                <h3>Account</h3>
                <button class="slideout-close" onclick="closeUserMenu()">√ó</button>
            </div>
            <div class="slideout-content">
                <div class="user-info">
                    <div class="user-avatar-large">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                    </div>
                    <div class="user-name" id="slideoutUserName">User Name</div>
                    <div class="user-email" id="slideoutUserEmail">user@example.com</div>
                </div>
                <ul class="slideout-menu">
                    <li>
                        <button onclick="showTab('summary', this); closeUserMenu();">
                            <span>üìä</span> Dashboard
                        </button>
                    </li>
                    <li>
                        <button onclick="showBackupSection(); closeUserMenu();">
                            <span>‚òÅÔ∏è</span> Backup & Sync
                        </button>
                    </li>
                    <li>
                        <button onclick="exportData(); closeUserMenu();">
                            <span>üì§</span> Export JSON
                        </button>
                    </li>
                    <li>
                        <button onclick="exportCSV(); closeUserMenu();">
                            <span>üìä</span> Export CSV
                        </button>
                    </li>
                    <li>
                        <button onclick="importData(); closeUserMenu();">
                            <span>üì•</span> Import Data
                        </button>
                    </li>
                    <li>
                        <button class="logout" onclick="logoutUser()">
                            <span>üö™</span> Sign Out
                        </button>
                    </li>
                </ul>
            </div>
        </div>

        <nav class="tab-navigation" id="mainNavigation">
            <button class="tab-button active" onclick="showTab('property', this)">Properties</button>
        </nav>

        <!-- Property Management Navigation (shown when property is selected) -->
        <nav class="tab-navigation" id="propertyNavigation" style="display: none;">
            <button class="tab-button" onclick="showTab('tenants', this)">Tenants</button>
            <button class="tab-button" onclick="showTab('monthly', this)">Monthly</button>
            <button class="tab-button" onclick="showTab('expenses', this)">Expenses</button>
            <button class="tab-button" onclick="showTab('moveouts', this)">Move Outs</button>
            <button class="tab-button" onclick="showTab('queries', this)">Tenant Queries</button>
            <button class="tab-button" onclick="showTab('summary', this)">Summary</button>
        </nav>

        <main class="content-area">
            <!-- Property Tab -->
            <div id="property" class="tab-content active">
                <div class="form-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>Properties</h3>
                        <button class="btn btn-primary" onclick="showAddPropertyForm()">‚ûï Add Property</button>
                    </div>
                    
                    <!-- Add Property Form (Hidden by default) -->
                    <div id="addPropertyForm" style="display: none;">
                        <h4>Add New Property</h4>
                        <form id="propertyForm">
                            <div class="form-group">
                                <label for="propertyName">Property Name</label>
                                <input type="text" id="propertyName" name="propertyName" placeholder="Sunset Apartments" required>
                            </div>
                            <div class="form-group">
                                <label for="propertyAddress">Address</label>
                                <input type="text" id="propertyAddress" name="propertyAddress" placeholder="123 Main Street, Nairobi, Kenya" required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="propertyType">Property Type</label>
                                    <select id="propertyType" name="propertyType" required>
                                        <option value="">Select type...</option>
                                        <option value="apartment">Apartment Building</option>
                                        <option value="house">House</option>
                                        <option value="townhouse">Townhouse Complex</option>
                                        <option value="commercial">Commercial Building</option>
                                        <option value="mixed">Mixed Use</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="propertyDescription">Description</label>
                                <textarea id="propertyDescription" name="propertyDescription" placeholder="Description of the property, amenities, etc." rows="3"></textarea>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="hideAddPropertyForm()">Cancel</button>
                                <button type="submit" class="btn btn-primary">Save Property</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Properties List -->
                <div id="propertiesList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üè¢</div>
                        <div class="empty-state-text">No properties yet</div>
                        <div class="empty-state-subtext">Add your first property to get started</div>
                    </div>
                </div>
            </div>

            <!-- Property Edit Overlay -->
            <div id="propertyEditOverlay" class="edit-overlay hidden">
                <div class="edit-page">
                    <div class="form-card">
                        <h3>Edit Property</h3>
                        <form id="propertyEditForm">
                            <div class="form-group">
                                <label for="editPropertyName">Property Name</label>
                                <input type="text" id="editPropertyName" name="propertyName" required>
                            </div>
                            <div class="form-group">
                                <label for="editPropertyAddress">Address</label>
                                <input type="text" id="editPropertyAddress" name="propertyAddress" required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="editPropertyType">Property Type</label>
                                    <select id="editPropertyType" name="propertyType" required>
                                        <option value="">Select type...</option>
                                        <option value="apartment">Apartment Building</option>
                                        <option value="house">House</option>
                                        <option value="townhouse">Townhouse Complex</option>
                                        <option value="commercial">Commercial Building</option>
                                        <option value="mixed">Mixed Use</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="editPropertyDescription">Description</label>
                                <textarea id="editPropertyDescription" name="propertyDescription" rows="3"></textarea>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="cancelPropertyEdit()">Cancel</button>
                                <button type="submit" class="btn btn-primary">Update Property</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Tenants Tab -->
            <div id="tenants" class="tab-content">
                <!-- Back to Properties button inside tab content -->
                <div id="tenantsBackButton" style="display: none; margin-bottom: 16px;">
                    <button class="btn btn-secondary" onclick="backToProperties()">‚Üê Back to Properties</button>
                </div>
                
                <!-- Toggle for the add-tenant form -->
                <button class="toggle-btn" id="tenantToggleBtn" onclick="toggleTenantForm()">‚ûï Add New Tenant</button>
                
                <!-- Add New Tenant Form (collapsible) -->
                <div id="tenantFormCollapsible" class="collapsed" style="overflow: hidden; transition: max-height 0.3s ease, opacity 0.3s ease; max-height: 0; opacity: 0;">
                    <div class="form-card">
                        <h3>Add New Tenant</h3>
                        <form id="addTenantForm">
                            <div class="form-group">
                                <label for="newTenantName">Tenant Name</label>
                                <input type="text" id="newTenantName" name="tenantName" placeholder="Enter tenant name" required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="newTenantUnit">Unit</label>
                                    <input type="text" id="newTenantUnit" name="tenantUnit" placeholder="A101" required>
                                </div>
                                <div class="form-group">
                                    <label for="newTenantRent">Rent Amount (Ksh)</label>
                                    <input type="number" id="newTenantRent" name="tenantRent" placeholder="50000" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="newTenantPhone">Phone Number</label>
                                <input type="tel" id="newTenantPhone" name="tenantPhone" placeholder="+254712345678">
                            </div>
                            <div class="form-group">
                                <label for="newTenantEmail">Email</label>
                                <input type="email" id="newTenantEmail" name="tenantEmail" placeholder="tenant@email.com">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="newTenantSince">Tenant Since</label>
                                    <input type="date" id="newTenantSince" name="tenantSince" required>
                                </div>
                                <div class="form-group">
                                    <label for="newDepositPaid">Deposit Paid (Ksh)</label>
                                    <input type="number" id="newDepositPaid" name="depositPaid" placeholder="0">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="newElectricityMeter">Electricity Meter #</label>
                                    <input type="text" id="newElectricityMeter" name="electricityMeter" placeholder="Meter number">
                                </div>
                                <div class="form-group">
                                    <label for="newElectricityBalance">Electricity Balance (Ksh)</label>
                                    <input type="number" id="newElectricityBalance" name="electricityBalance" placeholder="0">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="newWaterMeter">Water Meter #</label>
                                    <input type="text" id="newWaterMeter" name="waterMeter" placeholder="Meter number">
                                </div>
                                <div class="form-group">
                                    <label for="newWaterBalance">Water Balance (Ksh)</label>
                                    <input type="number" id="newWaterBalance" name="waterBalance" placeholder="0">
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="toggleTenantForm()">Cancel</button>
                                <button type="submit" class="btn btn-primary">Add Tenant</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Tenant Edit Overlay -->
<div id="tenantEditOverlay" class="edit-overlay hidden">
    <div class="edit-page">
        <div class="form-card">
            <h3 id="tenantFormTitle">Add New Tenant</h3>
            <form id="tenantForm">
                        <div class="form-group">
                            <label for="tenantName">Tenant Name</label>
                            <input type="text" id="tenantName" name="tenantName" placeholder="Enter tenant name" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="tenantUnit">Unit</label>
                                <input type="text" id="tenantUnit" name="tenantUnit" placeholder="A101" required>
                            </div>
                            <div class="form-group">
                                <label for="tenantRent">Rent Amount (Ksh)</label>
                                <input type="number" id="tenantRent" name="tenantRent" placeholder="50000" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="tenantPhone">Phone Number</label>
                            <input type="tel" id="tenantPhone" name="tenantPhone" placeholder="+254712345678">
                        </div>
                        <div class="form-group">
                            <label for="tenantEmail">Email</label>
                            <input type="email" id="tenantEmail" name="tenantEmail" placeholder="tenant@email.com">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="tenantSince">Tenant Since</label>
                                <input type="date" id="tenantSince" name="tenantSince" required>
                            </div>
                            <div class="form-group">
                                <label for="depositPaid">Deposit Paid (Ksh)</label>
                                <input type="number" id="depositPaid" name="depositPaid" placeholder="0">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="electricityMeter">Electricity Meter #</label>
                                <input type="text" id="electricityMeter" name="electricityMeter" placeholder="Meter number">
                            </div>
                            <div class="form-group">
                                <label for="electricityBalance">Electricity Balance (Ksh)</label>
                                <input type="number" id="electricityBalance" name="electricityBalance" placeholder="0">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="waterMeter">Water Meter #</label>
                                <input type="text" id="waterMeter" name="waterMeter" placeholder="Meter number">
                            </div>
                            <div class="form-group">
                                <label for="waterBalance">Water Balance (Ksh)</label>
                                <input type="number" id="waterBalance" name="waterBalance" placeholder="0">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="tenantNotes">Notes & References</label>
                            <textarea id="tenantNotes" name="tenantNotes" placeholder="Emergency contact, references, special notes..." rows="3" style="width: 100%; padding: 12px 16px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem; font-family: inherit; resize: vertical;"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="leaseDocument">Signed Lease Document</label>
                            <input type="file" id="leaseDocument" accept=".pdf,.jpg,.jpeg,.png" multiple capture="environment" style="display: none;">
                            <div id="leaseDocumentButtons" style="display: flex; gap: 8px; margin-bottom: 8px;">
                                <button type="button" id="leaseUploadBtn" class="btn btn-secondary" onclick="document.getElementById('leaseDocument').click()" style="flex: 1;">Upload</button>
                            </div>
                            <div id="leaseDocumentDisplay" style="margin-top: 8px; font-size: 0.875rem; color: #64748b;"></div>
                            <small style="color: #64748b; font-size: 0.75rem; margin-top: 4px; display: block;">Upload PDF or image of signed lease. You can upload up to 3 documents. Use camera to scan or file manager to select existing files.</small>
                        </div>
                        <div class="form-group">
                            <label for="tenantIdDocument">Identification Document</label>
                            <input type="file" id="tenantIdDocument" accept=".jpg,.jpeg,.png,.pdf" multiple capture="environment" style="display: none;">
                            <div id="idDocumentButtons" style="display: flex; gap: 8px; margin-bottom: 8px;">
                                <button type="button" id="idUploadBtn" class="btn btn-secondary" onclick="document.getElementById('tenantIdDocument').click()" style="flex: 1;">Upload</button>
                            </div>
                            <div id="tenantIdDocumentDisplay" style="margin-top: 8px; font-size: 0.875rem; color: #64748b;"></div>
                            <small style="color: #64748b; font-size: 0.75rem; margin-top: 4px; display: block;">Upload ID card, passport, or other identification. You can upload multiple files (PDF or images for front/back). Use camera to scan or file manager to select existing files.</small>
                        </div>
                        <div class="form-actions">
                            <button type="button" id="tenantCancelBtn" class="btn btn-secondary" style="display: none;">Cancel</button>
                            <button type="submit" class="btn btn-primary" style="flex: 1;">Save Tenant</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- End Tenant Edit Overlay -->

                <div class="entries-list" id="tenantsList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üë•</div>
                        <div class="empty-state-text">No tenants yet</div>
                        <div class="empty-state-subtext">Add your first tenant to get started</div>
                    </div>
                </div>
            </div>

            <!-- Monthly Tab -->
            <div id="monthly" class="tab-content">
                <!-- Back to Properties button inside tab content -->
                <div id="monthlyBackButton" style="display: none; margin-bottom: 16px;">
                    <button class="btn btn-secondary" onclick="backToProperties()">‚Üê Back to Properties</button>
                </div>
                
                <div class="form-card">
                    <h3>Record Monthly Payment</h3>
                    <form id="monthlyForm">
                        <div class="form-group">
                            <label for="monthlyTenant">Select Tenant</label>
                            <select id="monthlyTenant" name="monthlyTenant" required>
                                <option value="">Choose a tenant...</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="monthlyAmount">Amount (Ksh)</label>
                                <input type="number" id="monthlyAmount" name="monthlyAmount" placeholder="50000" required>
                            </div>
                            <div class="form-group">
                                <label for="monthlyDate">Date</label>
                                <input type="date" id="monthlyDate" name="monthlyDate" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="monthlyNotes">Notes</label>
                            <input type="text" id="monthlyNotes" name="monthlyNotes" placeholder="Payment method, etc.">
                        </div>
                        <div class="form-actions">
                            <button type="button" id="monthlyCancelBtn" class="btn btn-secondary" style="display: none;">Cancel</button>
                            <button type="submit" class="btn btn-success btn-full">Record Payment</button>
                        </div>
                    </form>
                </div>

                <!-- Monthly Edit Overlay -->
                <div id="monthlyEditOverlay" class="edit-overlay hidden">
                    <div class="edit-page">
                        <div class="form-card">
                            <h3 id="monthlyFormTitle">Record Monthly Payment</h3>
                            <form id="monthlyEditForm">
                                <div class="form-group">
                                    <label for="monthlyTenantEdit">Select Tenant</label>
                                    <select id="monthlyTenantEdit" name="monthlyTenant" required>
                                        <option value="">Choose a tenant...</option>
                                    </select>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="monthlyAmountEdit">Amount (Ksh)</label>
                                        <input type="number" id="monthlyAmountEdit" name="monthlyAmount" placeholder="50000" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="monthlyDateEdit">Date</label>
                                        <input type="date" id="monthlyDateEdit" name="monthlyDate" required>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="monthlyNotesEdit">Notes</label>
                                    <input type="text" id="monthlyNotesEdit" name="monthlyNotes" placeholder="Payment method, etc.">
                                </div>
                                <div class="form-actions">
                                    <button type="button" id="monthlyCancelBtn" class="btn btn-secondary">Cancel</button>
                                    <button type="submit" class="btn btn-success btn-full">Record Payment</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <!-- End Monthly Edit Overlay -->

                <div class="entries-list" id="monthlyList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üí∞</div>
                        <div class="empty-state-text">No payments recorded</div>
                        <div class="empty-state-subtext">Start tracking monthly payments</div>
                    </div>
                </div>
            </div>

            <!-- Expenses Tab -->
            <div id="expenses" class="tab-content">
                <!-- Back to Properties button inside tab content -->
                <div id="expensesBackButton" style="display: none; margin-bottom: 16px;">
                    <button class="btn btn-secondary" onclick="backToProperties()">‚Üê Back to Properties</button>
                </div>
                
                <div class="form-card">
                    <h3>Add Expense</h3>
                    <form id="expenseForm">
                        <div class="form-group">
                            <label for="expenseCategory">Category</label>
                            <select id="expenseCategory" name="expenseCategory" required>
                                <option value="">Select category...</option>
                                <option value="maintenance">Maintenance</option>
                                <option value="utilities">Utilities</option>
                                <option value="insurance">Insurance</option>
                                <option value="taxes">Property Taxes</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="expenseDescription">Description</label>
                            <input type="text" id="expenseDescription" name="expenseDescription" placeholder="What was this expense for?" required>
                        </div>
                        <div class="form-group">
                            <label for="expenseReference">Reference (optional)</label>
                            <input type="text" id="expenseReference" name="expenseReference" placeholder="Invoice #, receipt ref, vendor...">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="expenseAmount">Amount (Ksh)</label>
                                <input type="number" id="expenseAmount" name="expenseAmount" placeholder="25000" required>
                            </div>
                            <div class="form-group">
                                <label for="expenseDate">Date</label>
                                <input type="date" id="expenseDate" name="expenseDate" required>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="button" id="expenseCancelBtn" class="btn btn-secondary" style="display: none;">Cancel</button>
                            <button type="submit" class="btn btn-primary btn-full">Add Expense</button>
                        </div>
                    </form>
                </div>

                <!-- Expense Edit Overlay -->
                <div id="expenseEditOverlay" class="edit-overlay hidden">
                    <div class="edit-page">
                        <div class="form-card">
                            <h3 id="expenseFormTitle">Add Expense</h3>
                            <form id="expenseEditForm">
                                <div class="form-group">
                                    <label for="expenseCategoryEdit">Category</label>
                                    <select id="expenseCategoryEdit" name="expenseCategory" required>
                                        <option value="">Select category...</option>
                                        <option value="maintenance">Maintenance</option>
                                        <option value="utilities">Utilities</option>
                                        <option value="insurance">Insurance</option>
                                        <option value="taxes">Property Taxes</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="expenseDescriptionEdit">Description</label>
                                    <input type="text" id="expenseDescriptionEdit" name="expenseDescription" placeholder="What was this expense for?" required>
                                </div>
                                <div class="form-group">
                                    <label for="expenseReferenceEdit">Reference (optional)</label>
                                    <input type="text" id="expenseReferenceEdit" name="expenseReference" placeholder="Invoice #, receipt ref, vendor...">
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="expenseAmountEdit">Amount (Ksh)</label>
                                        <input type="number" id="expenseAmountEdit" name="expenseAmount" placeholder="25000" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="expenseDateEdit">Date</label>
                                        <input type="date" id="expenseDateEdit" name="expenseDate" required>
                                    </div>
                                </div>
                                <div class="form-actions">
                                    <button type="button" id="expenseCancelBtn" class="btn btn-secondary">Cancel</button>
                                    <button type="submit" class="btn btn-primary btn-full">Add Expense</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <!-- End Expense Edit Overlay -->

                <div class="entries-list" id="expensesList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <div class="empty-state-text">No expenses recorded</div>
                        <div class="empty-state-subtext">Track your property expenses</div>
                    </div>
                </div>
            </div>

            <!-- Move Outs Tab -->
            <div id="moveouts" class="tab-content">
                <!-- Back to Properties button inside tab content -->
                <div id="moveoutsBackButton" style="display: none; margin-bottom: 16px;">
                    <button class="btn btn-secondary" onclick="backToProperties()">‚Üê Back to Properties</button>
                </div>
                
                <div class="form-card">
                    <h3>Record Move Out</h3>
                    <form id="moveoutForm">
                        <div class="form-group">
                            <label for="moveoutTenant">Select Tenant</label>
                            <select id="moveoutTenant" name="moveoutTenant" required>
                                <option value="">Choose a tenant...</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="moveoutDate">Move Out Date</label>
                                <input type="date" id="moveoutDate" name="moveoutDate" required>
                            </div>
                            <div class="form-group">
                                <label for="depositReturned">Security Deposit (Ksh)</label>
                                <input type="number" id="depositReturned" name="depositReturned" placeholder="0">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="moveoutNotes">Notes</label>
                            <input type="text" id="moveoutNotes" name="moveoutNotes" placeholder="Reason for leaving, etc.">
                        </div>
                        <div class="form-actions">
                            <button type="button" id="moveOutCancelBtn" class="btn btn-secondary" style="display: none;">Cancel</button>
                            <button type="submit" class="btn btn-secondary btn-full">Record Move Out</button>
                        </div>
                    </form>
                </div>

                <!-- Move Out Edit Overlay -->
                <div id="moveOutEditOverlay" class="edit-overlay hidden">
                    <div class="edit-page">
                        <div class="form-card">
                            <h3 id="moveOutFormTitle">Record Move Out</h3>
                            <form id="moveoutEditForm">
                                <div class="form-group">
                                    <label for="moveoutTenantEdit">Select Tenant</label>
                                    <select id="moveoutTenantEdit" name="moveoutTenant" required>
                                        <option value="">Choose a tenant...</option>
                                    </select>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="moveoutDateEdit">Move Out Date</label>
                                        <input type="date" id="moveoutDateEdit" name="moveoutDate" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="depositReturnedEdit">Security Deposit (Ksh)</label>
                                        <input type="number" id="depositReturnedEdit" name="depositReturned" placeholder="0">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="moveoutNotesEdit">Notes</label>
                                    <input type="text" id="moveoutNotesEdit" name="moveoutNotes" placeholder="Reason for leaving, etc.">
                                </div>
                                <div class="form-actions">
                                    <button type="button" id="moveOutCancelBtn" class="btn btn-secondary">Cancel</button>
                                    <button type="submit" class="btn btn-secondary btn-full">Record Move Out</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <!-- End Move Out Edit Overlay -->

                <div class="entries-list" id="moveoutsList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üöö</div>
                        <div class="empty-state-text">No move outs recorded</div>
                        <div class="empty-state-subtext">Track tenant move outs</div>
                    </div>
                </div>
            </div>

            <!-- Summary Tab -->
            <div id="summary" class="tab-content">
                <!-- Back to Properties button inside tab content -->
                <div id="summaryBackButton" style="display: none; margin-bottom: 16px;">
                    <button class="btn btn-secondary" onclick="backToProperties()">‚Üê Back to Properties</button>
                </div>
                
                <div class="form-card">
                    <h3>üìä Summary Report</h3>
                    <div class="summary-cards" id="summaryCards">
                        <div class="summary-card">
                            <h4>Total Income</h4>
                            <div class="summary-amount income">Ksh 0</div>
                        </div>
                        <div class="summary-card">
                            <h4>Total Expenses</h4>
                            <div class="summary-amount expense">Ksh 0</div>
                        </div>
                        <div class="summary-card">
                            <h4>Net Income</h4>
                            <div class="summary-amount net">Ksh 0</div>
                        </div>
                    </div>
                </div>

                <div class="form-card">
                    <h3>Monthly Breakdown</h3>
                    <div id="summaryTable">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìà</div>
                            <div class="empty-state-text">No data to summarize</div>
                            <div class="empty-state-subtext">Add tenants and payments to see reports</div>
                        </div>
                    </div>
                </div>

                <div class="form-card">
                    <h3>Per-Tenant Summary</h3>
                    <p style="margin-bottom: 12px; color: #64748b;">Click a tenant to copy or share a concise summary. Payment type/notes are excluded.</p>
                    <div id="tenantSummaryList">
                        <div class="empty-state">
                            <div class="empty-state-icon">üë•</div>
                            <div class="empty-state-text">No tenant data yet</div>
                            <div class="empty-state-subtext">Add tenants and payments to generate per-tenant summaries</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="queries" class="tab-content">
                <!-- Back to Properties button inside tab content -->
                <div id="queriesBackButton" style="display: none; margin-bottom: 16px;">
                    <button class="btn btn-secondary" onclick="backToProperties()">‚Üê Back to Properties</button>
                </div>
                
                <div class="form-card">
                    <h3>Tenant Queries</h3>
                    <p style="margin-bottom:12px; color:#64748b;">Log tenant queries/issues and track resolution. Click a query to mark resolved.</p>
                    <div class="form-card">
                        <h4 style="margin-bottom:8px;">New Query</h4>
                        <form id="queryForm">
                            <div class="form-group">
                                <label for="queryTenant">Tenant</label>
                                <select id="queryTenant" required>
                                    <option value="">Select tenant...</option>
                                </select>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="queryDate">Date</label>
                                    <input type="date" id="queryDate" required>
                                </div>
                                <div class="form-group">
                                    <label for="queryResolved">Resolved</label>
                                    <select id="queryResolved">
                                        <option value="false">No</option>
                                        <option value="true">Yes</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="queryIssue">Issue</label>
                                <textarea id="queryIssue" rows="3" style="width:100%; padding:12px 16px; border:1px solid #d1d5db; border-radius:8px;"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="queryAction">Action Taken</label>
                                <textarea id="queryAction" rows="2" style="width:100%; padding:12px 16px; border:1px solid #d1d5db; border-radius:8px;"></textarea>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">Log Query</button>
                            </div>
                        </form>
                    </div>
                    <div style="margin-top:12px;">
                        <h4 style="margin-bottom:8px;">Queries</h4>
                        <div id="queriesList">
                            <div class="empty-state">
                                <div class="empty-state-icon">üìù</div>
                                <div class="empty-state-text">No queries yet</div>
                                <div class="empty-state-subtext">Tenant queries will appear here</div>
                            </div>
                        </div>
                    </div>
                </div>

            <!-- Backup Tab -->
            <div id="backup" class="tab-content">
                <div class="form-card">
                    <h3>‚òÅÔ∏è Backup & Cloud Sync</h3>
                    <p style="margin-bottom: 16px; color: #059669; font-weight: 500;">‚úÖ Your data is now automatically backed up to the cloud!</p>
                    <div class="backup-status" id="backupStatus">
                        <div class="status-item">
                            <span class="status-label">Storage Type:</span>
                            <span class="status-value">Local Storage + Firebase Cloud</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Cloud Sync:</span>
                            <span class="status-value" id="cloudSyncStatus">Syncing...</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Last Saved:</span>
                            <span class="status-value" id="lastBackup">Never</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Data Size:</span>
                            <span class="status-value" id="dataSize">0 KB</span>
                        </div>
                    </div>
                    </div>

                    <div class="form-card">
                        <h3>üì• Export Data</h3>
                    <p style="margin-bottom: 16px; color: #64748b;">Download your data as a backup file. Save this to Google Drive or other cloud storage.</p>
                    <div class="form-actions">
                        <button class="btn btn-primary" onclick="exportData()">Export JSON</button>
                        <button class="btn btn-secondary" onclick="exportCSV()">Export CSV</button>
                    </div>
                </div>

                <div class="form-card">
                    <h3>üì§ Import Data</h3>
                    <p style="margin-bottom: 16px; color: #64748b;">Restore data from a previously exported backup file.</p>
                    <div class="form-group">
                        <input type="file" id="importFile" accept=".json,.csv">
                        <small style="color: #64748b; font-size: 0.75rem; margin-top: 4px; display: block;">Select a previously exported backup file (.json or .csv format)</small>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-success" onclick="importData()">Import Data</button>
                    </div>
                </div>

                <div class="form-card">
                    <h3>üóëÔ∏è Clear Data</h3>
                    <p style="margin-bottom: 16px; color: #ef4444;">Permanently delete all data. This cannot be undone!</p>
                    <div class="form-actions">
                        <button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button>
                    </div>
                </div>
            </div>
        </main>

        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Online</span>
            </div>
        </div>
    </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getDatabase, ref, set, get, onValue } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { firebaseConfig } from './firebase-config.js';
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider();
        
        // Data storage
        let data = {
            properties: [],
            selectedPropertyId: null,
            tenants: [],
            monthly: [],
            expenses: [],
            moveOuts: [],
            queries: []
        };
        
        let isOnline = navigator.onLine;
        let hasSyncedOnce = false;
        let currentUser = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
        });

        // Check authentication status
        function checkAuthStatus() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    document.getElementById('authContainer').style.display = 'none';
                    document.getElementById('appContent').style.display = 'block';
                    
                    // Update user info in slideout
                    updateSlideoutUserInfo();
                    
                    loadData();
                    cleanupInvalidTenants();
                    initializeForms();
                    initializeNavigation();
                    updateTenantSelects();
                    renderAllEntries();
                    setDefaultDates();
                    initializePWA();
                    setupRealtimeSync();
                } else {
                    currentUser = null;
                    document.getElementById('authContainer').style.display = 'flex';
                    document.getElementById('appContent').style.display = 'none';
                }
            });
        }

        // Google Sign In
        async function loginWithGoogle() {
            try {
                showNotification('Opening Google Sign-In...');
                // Ensure auth persistence is set to local so user remains signed in after refresh
                await setPersistence(auth, browserLocalPersistence);
                const result = await signInWithPopup(auth, googleProvider);
                showNotification(`Welcome, ${result.user.displayName || result.user.email}!`);
            } catch (error) {
                console.error('Login error details:', error && error.code, error && error.message);

                // Provide helpful error messages
                let errorMsg = 'Login failed';
                if (error && error.code === 'auth/operation-not-allowed') {
                    errorMsg = 'Google Sign-In is not enabled. Please check Firebase console.';
                } else if (error && error.code === 'auth/popup-blocked') {
                    errorMsg = 'Pop-up was blocked. Please allow pop-ups and try again.';
                } else if (error && error.code === 'auth/popup-closed-by-user') {
                    errorMsg = 'Sign-in was cancelled.';
                } else if (error && error.message) {
                    errorMsg = error.message;
                }

                showNotification(errorMsg);
            }
        }

        // Logout
        async function logoutUser() {
            if (confirm('Are you sure you want to logout? Your data is saved to your Google account.')) {
                try {
                    await signOut(auth);
                    showNotification('Logged out successfully');
                } catch (error) {
                    console.error('Logout error:', error);
                    showNotification('Logout failed');
                }
            }
        }

        // Setup real-time sync with Firebase
        async function setupRealtimeSync() {
            if (!currentUser) return;
            const dataRef = ref(database, `users/${currentUser.uid}/rentalData`);

            try {
                // Try to read current cloud data once
                const snap = await get(dataRef);
                const firebaseData = snap.val();
                console.log('Initial sync read from Firebase:', firebaseData);

                if (firebaseData) {
                    // Cloud has data -> use it (first-time sync)
                    data = firebaseData || {};
                    // Ensure all arrays exist and properties structure
                    if (!data.properties) data.properties = [];
                    if (!data.selectedPropertyId) data.selectedPropertyId = null;
                    if (!data.tenants) data.tenants = [];
                    if (!data.monthly) data.monthly = [];
                    if (!data.expenses) data.expenses = [];
                    if (!data.moveOuts) data.moveOuts = [];
                    if (!data.queries) data.queries = [];
                    
                    // Migrate existing data if needed
                    migrateExistingDataToProperties();
                    
                    hasSyncedOnce = true;
                    console.log('Data loaded from cloud. Properties:', data.properties.length);
                    renderAllEntries();
                    updateTenantSelects();
                    updateSummary();
                    showNotification('‚úÖ Data synced from cloud (' + data.properties.length + ' properties)');
                } else {
                    // Cloud empty -> if local has data, upload it to cloud
                    const saved = localStorage.getItem('rentalManagerData');
                    if (saved) {
                        try {
                            const localData = JSON.parse(saved);
                            // Only upload if local actually contains records
                            const hasLocal = (localData.properties && localData.properties.length) || 
                                          (localData.tenants && localData.tenants.length) || 
                                          (localData.monthly && localData.monthly.length) || 
                                          (localData.expenses && localData.expenses.length) || 
                                          (localData.moveOuts && localData.moveOuts.length);
                            if (hasLocal) {
                                await set(dataRef, localData);
                                showNotification('Local data uploaded to cloud');
                                hasSyncedOnce = true;
                            }
                        } catch (err) {
                            console.warn('Failed to parse local data for upload:', err);
                        }
                    }
                }
            } catch (error) {
                console.warn('Realtime initial read error:', error);
                // fallback to local data
                loadData();
            }

            // Always subscribe to realtime updates so devices stay in sync
            onValue(dataRef, (snapshot) => {
                const firebaseData = snapshot.val();
                if (firebaseData) {
                    data = firebaseData;
                    renderAllEntries();
                    updateTenantSelects();
                    updateSummary();
                }
            }, (error) => {
                console.warn('Real-time sync listener error:', error);
            });
        }

        // Clean up invalid tenants (missing name or unit)
        function cleanupInvalidTenants() {
            if (!data.tenants) return;
            
            const originalCount = data.tenants.length;
            data.tenants = data.tenants.filter(tenant => {
                const name = tenant.name && tenant.name.trim() !== '';
                const unit = tenant.unit && tenant.unit.trim() !== '';
                return name && unit;
            });
            
            const removedCount = originalCount - data.tenants.length;
            if (removedCount > 0) {
                console.log(`Removed ${removedCount} invalid tenant(s) missing name or unit`);
                saveData();
            }
        }

        // Load data from localStorage (fallback)
        function loadData() {
            const savedData = localStorage.getItem('rentalManagerData');
            if (savedData) {
                data = JSON.parse(savedData);
                
                // Migrate existing data to new property structure
                migrateExistingDataToProperties();
            } else {
                // Initialize with empty structure for new users
                data = {
                    properties: [],
                    selectedPropertyId: null,
                    tenants: [],
                    monthly: [],
                    expenses: [],
                    moveOuts: [],
                    queries: []
                };
            }
        }

        // Migrate existing tenant data to Shirere Villas property
        function migrateExistingDataToProperties() {
            // Check if migration is needed (has tenants but no properties)
            if (data.tenants && data.tenants.length > 0 && (!data.properties || data.properties.length === 0)) {
                console.log('Migrating existing data to Shirere Villas property...');
                
                // Create Shirere Villas property
                const shirereVillas = {
                    id: Date.now(),
                    name: 'Shirere Villas',
                    address: 'P O Box 1053-00501 Kakamega',
                    type: 'Townhouse complex',
                    description: '2 and 3 bedroomed houses',
                    createdAt: new Date().toISOString(),
                    migrated: true
                };
                
                // Initialize properties array if it doesn't exist
                if (!data.properties) data.properties = [];
                
                // Add Shirere Villas
                data.properties.push(shirereVillas);
                
                // Update all existing tenants to belong to Shirere Villas
                data.tenants.forEach(tenant => {
                    tenant.propertyId = shirereVillas.id;
                });
                
                // Set Shirere Villas as the selected property
                data.selectedPropertyId = shirereVillas.id;
                
                // Save the migrated data
                saveData();
                
                console.log('Migration completed. Shirere Villas property created with', data.tenants.length, 'tenants');
                showNotification('üè† Data migrated: Shirere Villas property created with your existing data');
            }
        }

        // Save data to both localStorage and Firebase
        function saveData() {
            // Save to localStorage immediately
            localStorage.setItem('rentalManagerData', JSON.stringify(data));
            const now = new Date().toLocaleString();
            localStorage.setItem('lastSaved', now);
            
            // Save to Firebase if online and user is authenticated
            if (isOnline && currentUser) {
                const dataRef = ref(database, `users/${currentUser.uid}/rentalData`);
                set(dataRef, data).then(() => {
                    console.log('Data saved to Firebase');
                }).catch((error) => {
                    console.warn('Error saving to Firebase:', error);
                    showNotification('Warning: Only saved locally');
                });
            } else {
                showNotification('Offline - data saved locally. Will sync when online');
            }
            
            updateLastSaved();
            updateBackupInfo();
            showSaveIndicator();
        }
        
        // Monitor online/offline status
        window.addEventListener('online', () => {
            isOnline = true;
            showNotification('Back online - syncing data...');
            saveData(); // Sync any offline changes
        });
        
        window.addEventListener('offline', () => {
            isOnline = false;
            showNotification('You are offline - changes saved locally');
        });
        
        // PWA Auto-Update Detection
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.ready.then(reg => {
                // Check for updates every 60 seconds
                setInterval(() => {
                    reg.update();
                }, 60000);
                
                // Listen for service worker updates
                reg.addEventListener('updatefound', () => {
                    const newWorker = reg.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            showNotification('‚ú® App update available! Refresh to get the latest features.');
                        }
                    });
                });
            });
        }

        // Property management functions
        function showAddPropertyForm() {
            document.getElementById('addPropertyForm').style.display = 'block';
            document.getElementById('propertyName').focus();
        }

        function hideAddPropertyForm() {
            document.getElementById('addPropertyForm').style.display = 'none';
            document.getElementById('propertyForm').reset();
        }

        function savePropertyInfo() {
            const propertyName = document.getElementById('propertyName').value.trim();
            const propertyAddress = document.getElementById('propertyAddress').value.trim();
            const propertyType = document.getElementById('propertyType').value;
            const propertyDescription = document.getElementById('propertyDescription').value.trim();

            if (!propertyName || !propertyAddress || !propertyType) {
                showNotification('Please fill in all required property fields');
                return;
            }

            const property = {
                id: Date.now(),
                name: propertyName,
                address: propertyAddress,
                type: propertyType,
                description: propertyDescription,
                createdAt: new Date().toISOString()
            };

            data.properties.push(property);
            saveData();
            renderProperties();
            hideAddPropertyForm();
            showNotification('Property added successfully!');
        }

        function selectProperty(propertyId) {
            data.selectedPropertyId = propertyId;
            saveData();
            renderProperties();
            
            // Switch to property management navigation
            document.getElementById('mainNavigation').style.display = 'none';
            document.getElementById('propertyNavigation').style.display = 'flex';
            
            // Show inline back buttons in all property management tabs
            document.getElementById('tenantsBackButton').style.display = 'block';
            document.getElementById('monthlyBackButton').style.display = 'block';
            document.getElementById('expensesBackButton').style.display = 'block';
            document.getElementById('moveoutsBackButton').style.display = 'block';
            document.getElementById('summaryBackButton').style.display = 'block';
            document.getElementById('queriesBackButton').style.display = 'block';
            
            // Update all other tabs to show only data for selected property
            renderAllEntries();
            updateTenantSelects();
            
            // Switch to tenants tab after selecting property
            const tenantsTab = document.querySelector('#propertyNavigation button[onclick*="tenants"]');
            if (tenantsTab) {
                showTab('tenants', tenantsTab);
            }
            
            const selectedProperty = data.properties.find(p => p.id === propertyId);
            showNotification(`Now managing: ${selectedProperty.name}`);
        }

        function backToProperties() {
            data.selectedPropertyId = null;
            saveData();
            
            // Switch to main navigation
            document.getElementById('mainNavigation').style.display = 'flex';
            document.getElementById('propertyNavigation').style.display = 'none';
            
            // Hide inline back buttons in all property management tabs
            document.getElementById('tenantsBackButton').style.display = 'none';
            document.getElementById('monthlyBackButton').style.display = 'none';
            document.getElementById('expensesBackButton').style.display = 'none';
            document.getElementById('moveoutsBackButton').style.display = 'none';
            document.getElementById('summaryBackButton').style.display = 'none';
            document.getElementById('queriesBackButton').style.display = 'none';
            
            // Show properties tab
            const propertyTab = document.querySelector('#mainNavigation button[onclick*="property"]');
            if (propertyTab) {
                showTab('property', propertyTab);
            }
            
            showNotification('Back to Properties');
        }

        function renderProperties() {
            const container = document.getElementById('propertiesList');
            if (!container) return;

            const properties = data.properties || [];
            if (properties.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üè¢</div>
                        <div class="empty-state-text">No properties yet</div>
                        <div class="empty-state-subtext">Add your first property to get started</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = properties.map(property => {
                const isSelected = property.id === data.selectedPropertyId;
                const propertyTenants = (data.tenants || []).filter(t => t.propertyId === property.id);
                const occupiedUnits = propertyTenants.filter(t => !t.movedOut).length;
                const totalUnits = propertyTenants.length;

                return `
                    <div class="property-card ${isSelected ? 'selected' : ''}">
                        <div class="property-header">
                            <div class="property-title">${property.name}</div>
                            <div class="property-type">${property.type}</div>
                            ${isSelected ? '<div class="selected-badge">Selected</div>' : ''}
                        </div>
                        <div class="property-details">
                            <div class="property-address">${property.address}</div>
                            <div class="property-stats">
                                <span class="stat">${occupiedUnits}/${totalUnits} Occupied</span>
                                <span class="stat">${totalUnits - occupiedUnits} Vacant</span>
                            </div>
                            ${property.description ? `<div class="property-description">${property.description}</div>` : ''}
                        </div>
                        <div class="property-actions">
                            <button class="btn btn-small ${isSelected ? 'btn-secondary' : 'btn-primary'}" onclick="selectProperty(${property.id})">${isSelected ? 'Managing' : 'Manage'}</button>
                            <button class="btn btn-small btn-secondary" onclick="editProperty(${property.id})">Edit</button>
                            <button class="btn btn-small btn-danger" onclick="deleteProperty(${property.id})">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function deleteProperty(propertyId) {
            if (!confirm('Are you sure you want to delete this property? All associated tenant data will also be deleted.')) return;
            
            data.properties = data.properties.filter(p => p.id !== propertyId);
            data.tenants = data.tenants.filter(t => t.propertyId !== propertyId);
            data.monthly = data.monthly.filter(m => {
                const tenant = data.tenants.find(t => t.id === m.tenantId);
                return tenant && tenant.propertyId !== propertyId;
            });
            data.expenses = data.expenses.filter(e => {
                const tenant = data.tenants.find(t => t.id === e.tenantId);
                return tenant && tenant.propertyId !== propertyId;
            });
            data.moveOuts = data.moveOuts.filter(m => {
                const tenant = data.tenants.find(t => t.id === m.tenantId);
                return tenant && tenant.propertyId !== propertyId;
            });
            data.queries = data.queries.filter(q => {
                const tenant = data.tenants.find(t => t.id === q.tenantId);
                return tenant && tenant.propertyId !== propertyId;
            });
            
            if (data.selectedPropertyId === propertyId) {
                data.selectedPropertyId = null;
            }
            
            saveData();
            renderProperties();
            renderAllEntries();
            updateTenantSelects();
            showNotification('Property deleted successfully!');
        }

        function getSelectedProperty() {
            if (!data.selectedPropertyId) return null;
            return data.properties.find(p => p.id === data.selectedPropertyId);
        }

        // Property editing functions
        let editingPropertyId = null;

        function editProperty(propertyId) {
            const property = data.properties.find(p => p.id === propertyId);
            if (!property) return;

            editingPropertyId = propertyId;
            
            // Populate edit form with property data
            document.getElementById('editPropertyName').value = property.name || '';
            document.getElementById('editPropertyAddress').value = property.address || '';
            document.getElementById('editPropertyType').value = property.type || '';
            document.getElementById('editPropertyDescription').value = property.description || '';
            
            // Show edit overlay
            document.getElementById('propertyEditOverlay').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            // Focus on first field
            document.getElementById('editPropertyName').focus();
        }

        function cancelPropertyEdit() {
            editingPropertyId = null;
            document.getElementById('propertyEditOverlay').classList.add('hidden');
            document.body.style.overflow = '';
            document.getElementById('propertyEditForm').reset();
        }

        function updateProperty() {
            if (!editingPropertyId) return;

            const propertyName = document.getElementById('editPropertyName').value.trim();
            const propertyAddress = document.getElementById('editPropertyAddress').value.trim();
            const propertyType = document.getElementById('editPropertyType').value;
            const propertyDescription = document.getElementById('editPropertyDescription').value.trim();

            if (!propertyName || !propertyAddress || !propertyType) {
                showNotification('Please fill in all required property fields');
                return;
            }

            const propertyIndex = data.properties.findIndex(p => p.id === editingPropertyId);
            if (propertyIndex === -1) return;

            // Update property data
            data.properties[propertyIndex] = {
                ...data.properties[propertyIndex],
                name: propertyName,
                address: propertyAddress,
                type: propertyType,
                description: propertyDescription,
                updatedAt: new Date().toISOString()
            };

            saveData();
            renderProperties();
            cancelPropertyEdit();
            showNotification('Property updated successfully!');
        }

        // Tab switching
        function showTab(tabName, buttonElement) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons in both navigations
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked button
            buttonElement.classList.add('active');
            
            // Update specific tab content
            if (tabName === 'property') {
                renderProperties();
            } else if (tabName === 'tenants') {
                renderTenants();
            } else if (tabName === 'monthly') {
                renderMonthly();
            } else if (tabName === 'expenses') {
                renderExpenses();
            } else if (tabName === 'summary') {
                updateSummary();
            } else if (tabName === 'queries') {
                // ensure tenant selects are fresh and render queries
                updateTenantSelects();
                renderQueries();
            } else if (tabName === 'backup') {
                updateBackupInfo();
            }
        }

        // Initialize navigation state
        function initializeNavigation() {
            // Always start with Properties page for new users
            if (!data.selectedPropertyId || data.properties.length === 0) {
                // Show main navigation (Properties only)
                document.getElementById('mainNavigation').style.display = 'flex';
                document.getElementById('propertyNavigation').style.display = 'none';
                
                // Hide inline back buttons in all property management tabs
                document.getElementById('tenantsBackButton').style.display = 'none';
                document.getElementById('monthlyBackButton').style.display = 'none';
                document.getElementById('expensesBackButton').style.display = 'none';
                document.getElementById('moveoutsBackButton').style.display = 'none';
                document.getElementById('summaryBackButton').style.display = 'none';
                document.getElementById('queriesBackButton').style.display = 'none';
                
                // Ensure Properties tab is active and visible
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.getElementById('property').classList.add('active');
                
                // Remove active class from all buttons
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Set Properties button as active
                const propertyTab = document.querySelector('#mainNavigation button[onclick*="property"]');
                if (propertyTab) {
                    propertyTab.classList.add('active');
                }
            } else {
                // Show property management navigation for existing selected property
                document.getElementById('mainNavigation').style.display = 'none';
                document.getElementById('propertyNavigation').style.display = 'flex';
                
                // Show inline back buttons in all property management tabs
                document.getElementById('tenantsBackButton').style.display = 'block';
                document.getElementById('monthlyBackButton').style.display = 'block';
                document.getElementById('expensesBackButton').style.display = 'block';
                document.getElementById('moveoutsBackButton').style.display = 'block';
                document.getElementById('summaryBackButton').style.display = 'block';
                document.getElementById('queriesBackButton').style.display = 'block';
            }
        }

        // Initialize forms
        function initializeForms() {
            // Add new tenant form
            const addTenantForm = document.getElementById('addTenantForm');
            if (addTenantForm) {
                addTenantForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    addNewTenant();
                });
            }

            // Tenant form (for editing overlay)
            document.getElementById('tenantForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addTenant();
            });

            // Add file input change listeners for immediate display
            // Store existing files to accumulate
            window.existingLeaseFiles = [];
            window.existingIdFiles = [];
            
            // Add change detection listeners to all form fields
            const formFields = ['tenantName', 'tenantUnit', 'tenantRent', 'tenantPhone', 'tenantEmail', 
                              'tenantSince', 'depositPaid', 'tenantNotes', 'electricityMeter', 
                              'electricityBalance', 'waterMeter', 'waterBalance'];
            
            formFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                console.log('Setting up listener for field:', fieldId, field);
                if (field) {
                    field.addEventListener('input', () => {
                        console.log('INPUT EVENT FIRED on:', fieldId);
                        const currentState = JSON.stringify(Array.from(new FormData(document.getElementById('tenantForm'))));
                        console.log('Field changed:', fieldId);
                        console.log('Current state:', currentState);
                        console.log('Initial state:', tenantFormInitialState);
                        hasTenantFormChanged = currentState !== tenantFormInitialState;
                        console.log('Has changed:', hasTenantFormChanged);
                        updateTenantFormButtons();
                    });
                    field.addEventListener('change', () => {
                        console.log('CHANGE EVENT FIRED on:', fieldId);
                        const currentState = JSON.stringify(Array.from(new FormData(document.getElementById('tenantForm'))));
                        console.log('Field changed:', fieldId);
                        console.log('Current state:', currentState);
                        console.log('Initial state:', tenantFormInitialState);
                        hasTenantFormChanged = currentState !== tenantFormInitialState;
                        console.log('Has changed:', hasTenantFormChanged);
                        updateTenantFormButtons();
                    });
                }
            });
            
            // Add proper event listener for Cancel button
            const cancelBtn = document.getElementById('tenantCancelBtn');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', cancelTenantEdit);
            }
            
            document.getElementById('leaseDocument').addEventListener('change', function(e) {
                const newFiles = e.target.files;
                if (newFiles && newFiles.length > 0) {
                    // Combine existing files with new files (max 3)
                    const combinedFiles = [...window.existingLeaseFiles];
                    for (let i = 0; i < newFiles.length && combinedFiles.length < 3; i++) {
                        combinedFiles.push(newFiles[i]);
                    }
                    
                    // Create new FileList with combined files
                    const dt = new DataTransfer();
                    combinedFiles.forEach(file => dt.items.add(file));
                    this.files = dt.files;
                    
                    // Update existing files storage
                    window.existingLeaseFiles = combinedFiles;
                    
                    // Display files
                    let filesHtml = '<div style="margin-top: 8px;">';
                    for (let i = 0; i < combinedFiles.length; i++) {
                        filesHtml += `
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 4px 8px; background: #f8fafc; border-radius: 4px; margin-bottom: 4px;">
                                <span style="font-size: 0.875rem; color: #374151;">${combinedFiles[i].name}</span>
                                <button type="button" onclick="removeNewLeaseFile(${i})" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 2px; font-size: 16px;">√ó</button>
                            </div>
                        `;
                    }
                    filesHtml += '</div>';
                    document.getElementById('leaseDocumentDisplay').innerHTML = filesHtml;
                    
                    // Update upload button state
                    const uploadBtn = document.getElementById('leaseUploadBtn');
                    if (combinedFiles.length >= 3) {
                        uploadBtn.disabled = true;
                        uploadBtn.style.opacity = '0.5';
                        uploadBtn.style.cursor = 'not-allowed';
                        uploadBtn.textContent = 'Max 3 files';
                    } else {
                        uploadBtn.disabled = false;
                        uploadBtn.style.opacity = '1';
                        uploadBtn.style.cursor = 'pointer';
                        uploadBtn.textContent = 'Upload';
                    }
                }
                
                // Update change state
                if (window.editingTenantId) {
                    hasTenantFormChanged = true;
                    updateTenantFormButtons();
                }
            });

            document.getElementById('tenantIdDocument').addEventListener('change', function(e) {
                const newFiles = e.target.files;
                if (newFiles && newFiles.length > 0) {
                    // Combine existing files with new files (max 3)
                    const combinedFiles = [...window.existingIdFiles];
                    for (let i = 0; i < newFiles.length && combinedFiles.length < 3; i++) {
                        combinedFiles.push(newFiles[i]);
                    }
                    
                    // Create new FileList with combined files
                    const dt = new DataTransfer();
                    combinedFiles.forEach(file => dt.items.add(file));
                    this.files = dt.files;
                    
                    // Update existing files storage
                    window.existingIdFiles = combinedFiles;
                    
                    // Display files
                    let filesHtml = '<div style="margin-top: 8px;">';
                    for (let i = 0; i < combinedFiles.length; i++) {
                        filesHtml += `
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 4px 8px; background: #f8fafc; border-radius: 4px; margin-bottom: 4px;">
                                <span style="font-size: 0.875rem; color: #374151;">${combinedFiles[i].name}</span>
                                <button type="button" onclick="removeNewFile(${i})" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 2px; font-size: 16px;">√ó</button>
                            </div>
                        `;
                    }
                    filesHtml += '</div>';
                    document.getElementById('tenantIdDocumentDisplay').innerHTML = filesHtml;
                    
                    // Update upload button state
                    const uploadBtn = document.getElementById('idUploadBtn');
                    if (combinedFiles.length >= 3) {
                        uploadBtn.disabled = true;
                        uploadBtn.style.opacity = '0.5';
                        uploadBtn.style.cursor = 'not-allowed';
                        uploadBtn.textContent = 'Max 3 files';
                    } else {
                        uploadBtn.disabled = false;
                        uploadBtn.style.opacity = '1';
                        uploadBtn.style.cursor = 'pointer';
                        uploadBtn.textContent = 'Upload';
                    }
                }
                
                // Update change state
                if (window.editingTenantId) {
                    hasTenantFormChanged = true;
                    updateTenantFormButtons();
                }
            });

            // Monthly form
            document.getElementById('monthlyForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addMonthly();
            });

            // Monthly edit form
            const monthlyEditForm = document.getElementById('monthlyEditForm');
            if (monthlyEditForm) {
                monthlyEditForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    addMonthly();
                });
            }

            // Add change detection listeners to monthly form fields
            const monthlyFormFields = ['monthlyTenant', 'monthlyAmount', 'monthlyDate', 'monthlyNotes'];
            const monthlyEditFormFields = ['monthlyTenantEdit', 'monthlyAmountEdit', 'monthlyDateEdit', 'monthlyNotesEdit'];
            
            monthlyFormFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', () => {
                        const currentState = JSON.stringify(Array.from(new FormData(document.getElementById('monthlyForm'))));
                        hasMonthlyFormChanged = currentState !== monthlyFormInitialState;
                        updateMonthlyFormButtons();
                    });
                    field.addEventListener('change', () => {
                        const currentState = JSON.stringify(Array.from(new FormData(document.getElementById('monthlyForm'))));
                        hasMonthlyFormChanged = currentState !== monthlyFormInitialState;
                        updateMonthlyFormButtons();
                    });
                }
            });

            monthlyEditFormFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', () => {
                        const currentState = JSON.stringify(Array.from(new FormData(document.getElementById('monthlyEditForm'))));
                        hasMonthlyFormChanged = currentState !== monthlyFormInitialState;
                        updateMonthlyFormButtons();
                    });
                    field.addEventListener('change', () => {
                        const currentState = JSON.stringify(Array.from(new FormData(document.getElementById('monthlyEditForm'))));
                        hasMonthlyFormChanged = currentState !== monthlyFormInitialState;
                        updateMonthlyFormButtons();
                    });
                }
            });
            
            // Add proper event listener for Cancel button
            const monthlyCancelBtn = document.getElementById('monthlyCancelBtn');
            if (monthlyCancelBtn) {
                monthlyCancelBtn.addEventListener('click', cancelMonthlyEdit);
            }

            // Expense form
            document.getElementById('expenseForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addExpense();
            });

            // Add change detection listeners to expense form fields
            const expenseFormFields = ['expenseCategory', 'expenseDescription', 'expenseReference', 'expenseAmount', 'expenseDate'];
            
            expenseFormFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', () => {
                        const currentState = JSON.stringify(Array.from(new FormData(document.getElementById('expenseForm'))));
                        hasExpenseFormChanged = currentState !== expenseFormInitialState;
                        updateExpenseFormButtons();
                    });
                    field.addEventListener('change', () => {
                        const currentState = JSON.stringify(Array.from(new FormData(document.getElementById('expenseForm'))));
                        hasExpenseFormChanged = currentState !== expenseFormInitialState;
                        updateExpenseFormButtons();
                    });
                }
            });
            
            // Add proper event listener for Cancel button
            const expenseCancelBtn = document.getElementById('expenseCancelBtn');
            if (expenseCancelBtn) {
                expenseCancelBtn.addEventListener('click', cancelExpenseEdit);
            }

            // Move out form
            document.getElementById('moveoutForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addMoveOut();
            });

            // Add change detection listeners to move out form fields
            const moveOutFormFields = ['moveoutTenant', 'moveoutDate', 'depositReturned', 'moveoutNotes'];
            
            moveOutFormFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', () => {
                        const currentState = JSON.stringify(Array.from(new FormData(document.getElementById('moveoutForm'))));
                        hasMoveOutFormChanged = currentState !== moveOutFormInitialState;
                        updateMoveOutFormButtons();
                    });
                    field.addEventListener('change', () => {
                        const currentState = JSON.stringify(Array.from(new FormData(document.getElementById('moveoutForm'))));
                        hasMoveOutFormChanged = currentState !== moveOutFormInitialState;
                        updateMoveOutFormButtons();
                    });
                }
            });
            
            // Add proper event listener for Cancel button
            const moveOutCancelBtn = document.getElementById('moveOutCancelBtn');
            if (moveOutCancelBtn) {
                moveOutCancelBtn.addEventListener('click', cancelMoveOutEdit);
            }

            // Property form
            const propertyForm = document.getElementById('propertyForm');
            if (propertyForm) {
                propertyForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    savePropertyInfo();
                });
            }

            // Property edit form
            const propertyEditForm = document.getElementById('propertyEditForm');
            if (propertyEditForm) {
                propertyEditForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    updateProperty();
                });
            }

            // Query form
            const qForm = document.getElementById('queryForm');
            if (qForm) {
                qForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    addQuery();
                });
            }
        }

        // Toggle the Add Tenant collapsible form
        function toggleTenantForm() {
            const el = document.getElementById('tenantFormCollapsible');
            const btn = document.getElementById('tenantToggleBtn');
            if (!el) return;

            const isCollapsed = el.classList.contains('collapsed');
            if (isCollapsed) {
                el.classList.remove('collapsed');
                // Allow transition by setting explicit maxHeight
                el.style.maxHeight = el.scrollHeight + 'px';
                el.style.opacity = '1';
                if (btn) btn.textContent = '‚ûñ Hide Add Tenant';
            } else {
                // Smoothly collapse
                el.style.maxHeight = el.scrollHeight + 'px';
                requestAnimationFrame(() => {
                    el.classList.add('collapsed');
                    el.style.maxHeight = '0';
                    el.style.opacity = '0';
                });
                if (btn) btn.textContent = '‚ûï Add New Tenant';
            }
        }

        // Expose for inline onclick handlers
        window.toggleTenantForm = toggleTenantForm;
        window.addNewTenant = addNewTenant;

        // Add tenant
        function addNewTenant() {
            if (!data.selectedPropertyId) {
                showNotification('Please select a property first');
                return;
            }

            const form = document.getElementById('addTenantForm');
            if (!form) return;

            // Get form values
            const tenantName = document.getElementById('newTenantName').value.trim();
            const tenantUnit = document.getElementById('newTenantUnit').value.trim();
            const tenantRent = document.getElementById('newTenantRent').value;
            const tenantPhone = document.getElementById('newTenantPhone').value.trim();
            const tenantEmail = document.getElementById('newTenantEmail').value.trim();
            const tenantSince = document.getElementById('newTenantSince').value;
            const depositPaid = document.getElementById('newDepositPaid').value;
            const electricityMeter = document.getElementById('newElectricityMeter').value.trim();
            const electricityBalance = document.getElementById('newElectricityBalance').value;
            const waterMeter = document.getElementById('newWaterMeter').value.trim();
            const waterBalance = document.getElementById('newWaterBalance').value;

            // Validation
            if (!tenantName || !tenantUnit || !tenantRent || !tenantSince) {
                showNotification('Please fill in all required fields');
                return;
            }

            // Check for duplicate unit within the selected property
            const propertyTenants = (data.tenants || []).filter(t => t.propertyId === data.selectedPropertyId);
            const duplicateUnit = propertyTenants.find(t => t.unit === tenantUnit && !t.movedOut);
            if (duplicateUnit) {
                showNotification(`Unit ${tenantUnit} is already occupied by ${duplicateUnit.name}`);
                return;
            }

            // Create new tenant object
            const tenant = {
                id: Date.now(),
                propertyId: data.selectedPropertyId,
                name: tenantName,
                unit: tenantUnit,
                rent: Number(tenantRent),
                phone: tenantPhone,
                email: tenantEmail,
                since: tenantSince,
                depositPaid: Number(depositPaid) || 0,
                electricityMeter: electricityMeter,
                electricityBalance: Number(electricityBalance) || 0,
                waterMeter: waterMeter,
                waterBalance: Number(waterBalance) || 0,
                movedOut: false,
                createdAt: new Date().toISOString()
            };

            // Add tenant to data
            if (!data.tenants) data.tenants = [];
            data.tenants.push(tenant);

            // Save data
            saveData();

            // Update UI
            renderTenants();
            renderUnitsOverview();
            updateTenantSelects();

            // Reset form and collapse
            form.reset();
            toggleTenantForm();

            showNotification('Tenant added successfully!');
        }

        // Add tenant (for editing overlay)
        function addTenant() {
            const leaseFiles = document.getElementById('leaseDocument').files;
            const idFiles = document.getElementById('tenantIdDocument').files;
            
            // Get form values
            const name = document.getElementById('tenantName').value.trim();
            const unit = document.getElementById('tenantUnit').value.trim();
            const rent = document.getElementById('tenantRent').value;
            const phone = document.getElementById('tenantPhone').value.trim();
            const email = document.getElementById('tenantEmail').value.trim();
            const since = document.getElementById('tenantSince').value;
            const depositPaid = document.getElementById('depositPaid').value;
            const notes = document.getElementById('tenantNotes').value.trim();
            const electricityMeter = document.getElementById('electricityMeter') ? document.getElementById('electricityMeter').value.trim() : '';
            const electricityBalance = document.getElementById('electricityBalance') ? parseFloat(document.getElementById('electricityBalance').value) || 0 : 0;
            const waterMeter = document.getElementById('waterMeter') ? document.getElementById('waterMeter').value.trim() : '';
            const waterBalance = document.getElementById('waterBalance') ? parseFloat(document.getElementById('waterBalance').value) || 0 : 0;
            
            // Validate required fields
            if (!name) {
                showNotification('Please enter tenant name');
                return;
            }
            
            if (!data.selectedPropertyId) {
                showNotification('Please select a property first');
                return;
            }
            
            if (!unit) {
                showNotification('Please enter unit name - this is required');
                return;
            }
            
            // Check if unit is already taken by an active tenant in the selected property (not moved out)
            const existingTenant = (data.tenants || []).find(t => 
                t.unit.toLowerCase() === unit.toLowerCase() && 
                !t.movedOut && 
                t.propertyId === data.selectedPropertyId && 
                t.id !== window.editingTenantId
            );
            if (existingTenant) {
                showNotification(`Unit ${unit} is already occupied by ${existingTenant.name}`);
                return;
            }
            
            if (!rent || parseFloat(rent) <= 0) {
                showNotification('Please enter a valid rent amount');
                return;
            }
            
            if (!since) {
                showNotification('Please enter tenant since date');
                return;
            }
            
            // Process multiple lease files
            let leaseDocuments = [];
            if (leaseFiles && leaseFiles.length > 0) {
                if (window.editingTenantId) {
                    // Editing mode: append new files to existing documents
                    const existingTenant = data.tenants.find(t => t.id === window.editingTenantId);
                    const existingLeaseDocs = existingTenant?.leaseDocuments || [];
                    if (existingTenant?.leaseDocument && !existingLeaseDocs.length) {
                        // Convert old single format to array
                        existingLeaseDocs.push(existingTenant.leaseDocument);
                    }
                    
                    // Combine existing and new files (max 3)
                    leaseDocuments = [...existingLeaseDocs];
                    for (let i = 0; i < leaseFiles.length && leaseDocuments.length < 3; i++) {
                        leaseDocuments.push({
                            name: leaseFiles[i].name,
                            size: leaseFiles[i].size,
                            type: leaseFiles[i].type,
                            lastModified: leaseFiles[i].lastModified
                        });
                    }
                } else {
                    // New tenant mode: just use the new files (max 3)
                    for (let i = 0; i < leaseFiles.length && i < 3; i++) {
                        leaseDocuments.push({
                            name: leaseFiles[i].name,
                            size: leaseFiles[i].size,
                            type: leaseFiles[i].type,
                            lastModified: leaseFiles[i].lastModified
                        });
                    }
                }
            } else if (window.editingTenantId) {
                // Editing mode with no new files: keep existing documents
                const existingTenant = data.tenants.find(t => t.id === window.editingTenantId);
                if (existingTenant) {
                    leaseDocuments = existingTenant.leaseDocuments || [];
                    if (existingTenant.leaseDocument && !leaseDocuments.length) {
                        leaseDocuments = [existingTenant.leaseDocument];
                    }
                }
            }
            
            // Process multiple ID files
            let idDocuments = [];
            if (idFiles && idFiles.length > 0) {
                if (window.editingTenantId) {
                    // Editing mode: append new files to existing documents
                    const existingTenant = data.tenants.find(t => t.id === window.editingTenantId);
                    const existingDocs = existingTenant?.idDocuments || [];
                    if (existingTenant?.idDocument && !existingDocs.length) {
                        // Convert old single format to array
                        existingDocs.push(existingTenant.idDocument);
                    }
                    
                    // Combine existing and new files (max 3)
                    idDocuments = [...existingDocs];
                    for (let i = 0; i < idFiles.length && idDocuments.length < 3; i++) {
                        idDocuments.push({
                            name: idFiles[i].name,
                            size: idFiles[i].size,
                            type: idFiles[i].type,
                            lastModified: idFiles[i].lastModified
                        });
                    }
                } else {
                    // New tenant mode: just use the new files (max 3)
                    for (let i = 0; i < idFiles.length && i < 3; i++) {
                        idDocuments.push({
                            name: idFiles[i].name,
                            size: idFiles[i].size,
                            type: idFiles[i].type,
                            lastModified: idFiles[i].lastModified
                        });
                    }
                }
            } else if (window.editingTenantId) {
                // Editing mode with no new files: keep existing documents
                const existingTenant = data.tenants.find(t => t.id === window.editingTenantId);
                if (existingTenant) {
                    idDocuments = existingTenant.idDocuments || [];
                    if (existingTenant.idDocument && !idDocuments.length) {
                        idDocuments = [existingTenant.idDocument];
                    }
                }
            }
            
            const tenant = {
                id: window.editingTenantId || Date.now(),
                propertyId: data.selectedPropertyId,
                name: name,
                unit: unit,
                rent: rent,
                phone: phone,
                email: email,
                since: since,
                depositPaid: depositPaid,
                notes: notes,
                electricityMeter: electricityMeter,
                electricityBalance: electricityBalance,
                waterMeter: waterMeter,
                waterBalance: waterBalance,
                leaseDocuments: leaseDocuments,
                idDocuments: idDocuments,
                createdAt: new Date().toISOString()
            };

            if (window.editingTenantId) {
                // Update existing tenant
                const index = data.tenants.findIndex(t => t.id === window.editingTenantId);
                if (index !== -1) {
                    data.tenants[index] = tenant;
                    showNotification('Tenant updated successfully!');
                }
                window.editingTenantId = null;
            } else {
                // Add new tenant
                data.tenants.push(tenant);
                showNotification('Tenant added successfully!');
            }
            
            saveData();
            renderTenants();
            renderUnitsOverview();
            updateTenantSelects();
            
            if (window.editingTenantId === null && data.tenants[data.tenants.length - 1].id === tenant.id) {
                // This was a new tenant addition, reset form
                document.getElementById('tenantForm').reset();
                
                // Reset form heading
                document.getElementById('tenantFormTitle').textContent = 'Add New Tenant';
                
                // Hide cancel button
                document.getElementById('tenantCancelBtn').style.display = 'none';
                
                // Reset save button text
                const tenantSaveBtn = document.querySelector('#tenantForm button[type="submit"]');
                tenantSaveBtn.textContent = 'Save Tenant';
                
                // Reset document displays
                document.getElementById('leaseDocumentDisplay').innerHTML = '';
                document.getElementById('tenantIdDocumentDisplay').innerHTML = '';
                
                // Reset button states
                document.getElementById('leaseUploadBtn').textContent = 'Upload';
                document.getElementById('leaseUploadBtn').className = 'btn btn-secondary';
                
                // Reset ID document buttons
                document.getElementById('idDocumentButtons').innerHTML = '<button type="button" id="idUploadBtn" class="btn btn-secondary" onclick="document.getElementById(\'tenantIdDocument\').click()" style="flex: 1;">Upload</button>';
                
                // Reset lease document buttons
                document.getElementById('leaseDocumentButtons').innerHTML = '<button type="button" id="leaseUploadBtn" class="btn btn-secondary" onclick="document.getElementById(\'leaseDocument\').click()" style="flex: 1;">Upload</button>';
                
                // Clear accumulated files
                window.existingLeaseFiles = [];
                window.existingIdFiles = [];
                
                window.idDocumentMode = 'new';
            } else {
                // This was an update, close overlay instead
                document.getElementById('tenantEditOverlay').classList.add('hidden');
                document.body.style.overflow = '';
                showNotification('Tenant updated successfully!');
            }
            
            // Collapse form after successful save
            const formContainer = document.getElementById('tenantFormCollapsible');
            const toggleBtn = document.getElementById('tenantToggleBtn');
            if (formContainer && !formContainer.classList.contains('collapsed')) {
                formContainer.classList.add('collapsed');
                if (toggleBtn) toggleBtn.textContent = '‚ûï Add New Tenant';
            }
        }

        // Add monthly payment
        function addMonthly() {
            // Ensure data.monthly exists
            if (!data.monthly) data.monthly = [];
            
            // Determine which form to use based on edit mode
            const isEditMode = window.editingMonthlyId !== null;
            const formPrefix = isEditMode ? 'Edit' : '';
            
            const tenantId = document.getElementById('monthlyTenant' + formPrefix).value;
            const amount = document.getElementById('monthlyAmount' + formPrefix).value;
            const date = document.getElementById('monthlyDate' + formPrefix).value;
            
            // Validate tenant selection
            if (!tenantId) {
                showNotification('Please select a tenant first!');
                return;
            }
            
            // Validate amount
            if (!amount || parseFloat(amount) <= 0) {
                showNotification('Please enter a valid amount');
                return;
            }
            
            // Validate date
            if (!date) {
                showNotification('Please select a date');
                return;
            }
            
            const payment = {
                id: window.editingMonthlyId || Date.now(),
                tenantId: tenantId,
                amount: amount,
                date: date,
                notes: document.getElementById('monthlyNotes' + formPrefix).value,
                createdAt: new Date().toISOString()
            };

            if (window.editingMonthlyId) {
                // Update existing payment
                const index = data.monthly.findIndex(p => p.id === window.editingMonthlyId);
                if (index !== -1) {
                    data.monthly[index] = payment;
                    showNotification('Payment updated successfully!');
                }
                window.editingMonthlyId = null;
            } else {
                // Add new payment
                data.monthly.push(payment);
                showNotification('Payment recorded successfully!');
            }
            
            saveData();
            renderMonthly();
            
            if (window.editingMonthlyId === null && data.monthly[data.monthly.length - 1].id === payment.id) {
                // This was a new payment addition, reset form
                document.getElementById('monthlyForm').reset();
                setDefaultDates();
                
                // Reset save button text
                const monthlySaveBtn = document.querySelector('#monthlyForm button[type="submit"]');
                monthlySaveBtn.textContent = 'Record Payment';
                
                // Hide cancel button
                document.getElementById('monthlyCancelBtn').style.display = 'none';
            } else {
                // This was an update, close overlay instead
                document.getElementById('monthlyEditOverlay').classList.add('hidden');
                document.body.style.overflow = '';
                
                // Reset edit form
                document.getElementById('monthlyEditForm').reset();
                
                // Reset form heading
                document.getElementById('monthlyFormTitle').textContent = 'Record Monthly Payment';
                
                // Reset save button text
                const monthlySaveBtn = document.querySelector('#monthlyEditForm button[type="submit"]');
                monthlySaveBtn.textContent = 'Record Payment';
                
                // Hide cancel button
                document.getElementById('monthlyCancelBtn').style.display = 'none';
                
                showNotification('Payment updated successfully!');
            }
        }

        // Add expense
        function addExpense() {
            // Ensure data.expenses exists
            if (!data.expenses) data.expenses = [];
            
            const expense = {
                id: window.editingExpenseId || Date.now(),
                category: document.getElementById('expenseCategory').value,
                description: document.getElementById('expenseDescription').value,
                reference: document.getElementById('expenseReference') ? document.getElementById('expenseReference').value : '',
                amount: document.getElementById('expenseAmount').value,
                date: document.getElementById('expenseDate').value,
                createdAt: new Date().toISOString()
            };

            if (window.editingExpenseId) {
                // Update existing expense
                const index = data.expenses.findIndex(e => e.id === window.editingExpenseId);
                if (index !== -1) {
                    data.expenses[index] = expense;
                    showNotification('Expense updated successfully!');
                }
                window.editingExpenseId = null;
            } else {
                // Add new expense
                data.expenses.push(expense);
                showNotification('Expense added successfully!');
            }
            
            saveData();
            renderExpenses();
            
            if (window.editingExpenseId === null && data.expenses[data.expenses.length - 1].id === expense.id) {
                // This was a new expense addition, reset form
                document.getElementById('expenseForm').reset();
                setDefaultDates();
                
                // Reset save button text
                const expenseSaveBtn = document.querySelector('#expenseForm button[type="submit"]');
                expenseSaveBtn.textContent = 'Add Expense';
                
                // Hide cancel button
                document.getElementById('expenseCancelBtn').style.display = 'none';
            } else {
                // This was an update, close overlay instead
                document.getElementById('expenseEditOverlay').classList.add('hidden');
                document.body.style.overflow = '';
                showNotification('Expense updated successfully!');
            }
        }

        // Add move out
        function addMoveOut() {
            // Ensure data.moveOuts exists
            if (!data.moveOuts) data.moveOuts = [];
            
            // Determine which form to use based on edit mode
            const isEditMode = window.editingMoveOutId !== null;
            const formPrefix = isEditMode ? 'Edit' : '';
            
            const moveOut = {
                id: window.editingMoveOutId || Date.now(),
                tenantId: document.getElementById('moveoutTenant' + formPrefix).value,
                date: document.getElementById('moveoutDate' + formPrefix).value,
                depositReturned: document.getElementById('depositReturned' + formPrefix).value,
                notes: document.getElementById('moveoutNotes' + formPrefix).value,
                createdAt: new Date().toISOString()
            };

            if (window.editingMoveOutId) {
                // Update existing move out
                const index = data.moveOuts.findIndex(m => m.id === window.editingMoveOutId);
                if (index !== -1) {
                    data.moveOuts[index] = moveOut;
                    showNotification('Move out updated successfully!');
                }
                window.editingMoveOutId = null;
            } else {
                // Add new move out
                data.moveOuts.push(moveOut);
                
                // Mark tenant as moved out and free up the unit
                const tenant = data.tenants.find(t => t.id === moveOut.tenantId);
                if (tenant) {
                    console.log('Moving out tenant:', tenant.name, 'from unit:', tenant.unit);
                    tenant.movedOut = true;
                    tenant.moveOutDate = moveOut.date;
                    tenant.depositReturned = moveOut.depositReturned;
                    tenant.moveOutNotes = moveOut.notes;
                    // IMPORTANT: Preserve the unit field for historical records
                    // The unit will be available for new tenants because duplicate checking excludes movedOut tenants
                    console.log('Tenant moved out, unit preserved:', tenant.unit);
                }
                
                showNotification('Move out recorded successfully!');
            }
            
            saveData();
            renderMoveOuts();
            renderTenants(); // Re-render tenants to show moved out status
            updateTenantSelects(); // Update tenant selects to exclude moved out tenants
            
            if (window.editingMoveOutId === null && data.moveOuts[data.moveOuts.length - 1].id === moveOut.id) {
                // This was a new move out addition, reset form
                document.getElementById('moveoutForm').reset();
                setDefaultDates();
                
                // Reset save button text
                const moveoutSaveBtn = document.querySelector('#moveoutForm button[type="submit"]');
                moveoutSaveBtn.textContent = 'Record Move Out';
                
                // Hide cancel button
                document.getElementById('moveOutCancelBtn').style.display = 'none';
            } else {
                // This was an update, close overlay instead
                document.getElementById('moveOutEditOverlay').classList.add('hidden');
                document.body.style.overflow = '';
                showNotification('Move out updated successfully!');
            }
        }

        // Render all entries
        function renderAllEntries() {
            renderProperties();
            renderTenants();
            renderMonthly();
            renderExpenses();
            renderMoveOuts();
            renderQueries();
        }

        // Render tenants
        function renderTenants() {
            const container = document.getElementById('tenantsList');
            
            if (!data.selectedPropertyId) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üè¢</div>
                        <div class="empty-state-text">No property selected</div>
                        <div class="empty-state-subtext">Go to Properties tab and select a property to manage</div>
                    </div>
                `;
                return;
            }
            
            const propertyTenants = (data.tenants || []).filter(t => t.propertyId === data.selectedPropertyId);
            
            if (!propertyTenants || propertyTenants.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë•</div>
                        <div class="empty-state-text">No tenants yet</div>
                        <div class="empty-state-subtext">Add your first tenant to get started</div>
                    </div>
                `;
                return;
            }

            // Sort tenants by numeric part of unit when possible, fallback to string
            const sortedTenants = propertyTenants.slice().sort((a, b) => {
                const aNum = parseInt((a.unit || '').match(/\d+/)?.[0] || '0');
                const bNum = parseInt((b.unit || '').match(/\d+/)?.[0] || '0');
                if (aNum !== bNum) return aNum - bNum;
                return String(a.unit || '').localeCompare(String(b.unit || ''));
            });

            container.innerHTML = sortedTenants.map(tenant => `
                <div class="entry-card ${tenant.movedOut ? 'moved-out-tenant' : ''}">
                    <div class="entry-header">
                        <div class="entry-title">${tenant.name}</div>
                        <div class="entry-amount">Ksh ${tenant.rent}</div>
                        ${tenant.movedOut ? `<div class="moved-out-stamp">Moved Out ${tenant.moveOutDate ? new Date(tenant.moveOutDate).toLocaleDateString() : ''}</div>` : ''}
                    </div>
                    <div class="entry-details">
                        <div>Unit: ${tenant.unit}</div>
                        <div>Phone: ${tenant.phone || 'Not provided'}</div>
                        <div>Email: ${tenant.email || 'Not provided'}</div>
                        <div>Tenant Since: ${tenant.since ? new Date(tenant.since).toLocaleDateString() : 'Not specified'}</div>
                        <div>Deposit: Ksh ${tenant.depositPaid || 0}</div>
                        <div>Electricity: ${tenant.electricityMeter || '‚Äî'} (Balance: Ksh ${tenant.electricityBalance || 0})</div>
                        <div>Water: ${tenant.waterMeter || '‚Äî'} (Balance: Ksh ${tenant.waterBalance || 0})</div>
                        ${tenant.notes ? `<div style="margin-top: 8px; padding: 8px; background: #f8fafc; border-radius: 6px; font-size: 0.875rem; color: #64748b;">${tenant.notes}</div>` : ''}
                        <div style="margin-top: 8px;">
                            <span style="color: ${(tenant.leaseDocuments && tenant.leaseDocuments.length > 0) || tenant.leaseDocument ? '#10b981' : '#ef4444'}; font-size: 0.75rem;">
                                üìÑ Lease: ${(tenant.leaseDocuments && tenant.leaseDocuments.length > 0) ? `${tenant.leaseDocuments.length} file(s)` : (tenant.leaseDocument ? 'Uploaded' : 'Not uploaded')}
                            </span>
                            <span style="margin-left: 12px; color: ${(tenant.idDocuments && tenant.idDocuments.length > 0) || tenant.idDocument ? '#10b981' : '#ef4444'}; font-size: 0.75rem;">
                                üÜî ID: ${(tenant.idDocuments && tenant.idDocuments.length > 0) ? `${tenant.idDocuments.length} file(s)` : (tenant.idDocument ? 'Uploaded' : 'Not uploaded')}
                            </span>
                        </div>
                    </div>
                    <div class="entry-actions">
                        <button class="btn btn-small btn-secondary" onclick="editTenant(${tenant.id})">Edit</button>
                        <button class="btn btn-small btn-danger" onclick="deleteTenant(${tenant.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Render monthly payments
        function renderMonthly() {
            const container = document.getElementById('monthlyList');
            
            // Ensure data.monthly exists
            if (!data.monthly || data.monthly.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí∞</div>
                        <div class="empty-state-text">No payments recorded</div>
                        <div class="empty-state-subtext">Start tracking monthly payments</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = data.monthly.map(payment => {
                const tenant = data.tenants.find(t => t.id == payment.tenantId);
                return `
                    <div class="entry-card">
                        <div class="entry-header">
                            <div class="entry-title">${tenant ? tenant.name : 'Unknown Tenant'}</div>
                            <div class="entry-amount">Ksh ${payment.amount}</div>
                        </div>
                        <div class="entry-details">
                            <div>Date: ${new Date(payment.date).toLocaleDateString()}</div>
                            <div>${payment.notes || 'No notes'}</div>
                        </div>
                        <div class="entry-actions">
                            <button class="btn btn-small btn-secondary" onclick="editMonthly(${payment.id})">Edit</button>
                            <button class="btn btn-small btn-danger" onclick="deleteMonthly(${payment.id})">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render expenses
        function renderExpenses() {
            const container = document.getElementById('expensesList');
            
            if (!data.expenses || data.expenses.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <div class="empty-state-text">No expenses recorded</div>
                        <div class="empty-state-subtext">Track your property expenses</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = data.expenses.map(expense => `
                <div class="entry-card">
                    <div class="entry-header">
                        <div class="entry-title">${expense.description}</div>
                        <div class="entry-amount">Ksh ${expense.amount}</div>
                    </div>
                    <div class="entry-details">
                        <div>Category: ${expense.category}</div>
                        <div>Date: ${new Date(expense.date).toLocaleDateString()}</div>
                        ${expense.reference ? `<div>Reference: ${expense.reference}</div>` : ''}
                    </div>
                    <div class="entry-actions">
                        <button class="btn btn-small btn-secondary" onclick="editExpense(${expense.id})">Edit</button>
                        <button class="btn btn-small btn-danger" onclick="deleteExpense(${expense.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Render move outs
        function renderMoveOuts() {
            const container = document.getElementById('moveoutsList');
            
            if (!data.selectedPropertyId) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üè¢</div>
                        <div class="empty-state-text">No property selected</div>
                        <div class="empty-state-subtext">Go to Properties tab and select a property to manage</div>
                    </div>
                `;
                return;
            }
            
            // Filter move outs by selected property
            const propertyTenants = (data.tenants || []).filter(t => t.propertyId === data.selectedPropertyId);
            const propertyTenantIds = new Set(propertyTenants.map(t => t.id));
            const propertyMoveOuts = (data.moveOuts || []).filter(mo => propertyTenantIds.has(mo.tenantId));
            
            if (!propertyMoveOuts || propertyMoveOuts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üöö</div>
                        <div class="empty-state-text">No move outs recorded</div>
                        <div class="empty-state-subtext">Track tenant move outs for this property</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = propertyMoveOuts.map(moveOut => {
                const tenant = propertyTenants.find(t => t.id === moveOut.tenantId);
                return `
                    <div class="entry-card">
                        <div class="entry-header">
                            <div class="entry-title">${tenant ? tenant.name : 'Unknown Tenant'}</div>
                            <div class="entry-amount">Ksh ${moveOut.depositReturned || 0}</div>
                        </div>
                        <div class="entry-details">
                            <div>Unit: ${tenant ? tenant.unit : 'Unknown'}</div>
                            <div>Move Out Date: ${new Date(moveOut.date).toLocaleDateString()}</div>
                            <div>${moveOut.notes || 'No notes'}</div>
                        </div>
                        <div class="entry-actions">
                            <button class="btn btn-small btn-secondary" onclick="editMoveOut(${moveOut.id})">Edit</button>
                            <button class="btn btn-small btn-danger" onclick="deleteMoveOut(${moveOut.id})">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update tenant selects
        function updateTenantSelects() {
            const monthlySelect = document.getElementById('monthlyTenant');
            const moveoutSelect = document.getElementById('moveoutTenant');
            const querySelect = document.getElementById('queryTenant');

            // Filter tenants by selected property first
            const propertyTenants = data.selectedPropertyId 
                ? (data.tenants || []).filter(t => t.propertyId === data.selectedPropertyId)
                : [];

            // Filter out moved out tenants for selects (except move out form which should show all tenants)
            const activeTenants = propertyTenants.filter(t => !t.movedOut);
            const allTenants = propertyTenants;

            const tenantsList = activeTenants.slice().sort((a, b) => {
                const aNum = parseInt((a.unit || '').match(/\d+/)?.[0] || '0');
                const bNum = parseInt((b.unit || '').match(/\d+/)?.[0] || '0');
                if (aNum !== bNum) return aNum - bNum;
                return String(a.unit || '').localeCompare(String(b.unit || ''));
            });

            const allTenantsList = allTenants.slice().sort((a, b) => {
                const aNum = parseInt((a.unit || '').match(/\d+/)?.[0] || '0');
                const bNum = parseInt((b.unit || '').match(/\d+/)?.[0] || '0');
                if (aNum !== bNum) return aNum - bNum;
                return String(a.unit || '').localeCompare(String(b.unit || ''));
            });

            const tenantOptions = tenantsList.map(tenant => `<option value="${tenant.id}">${tenant.name} - ${tenant.unit}</option>`).join('');
            const allTenantOptions = allTenantsList.map(tenant => `<option value="${tenant.id}">${tenant.name} - ${tenant.unit}${tenant.movedOut ? ' (Moved Out)' : ''}</option>`).join('');
            
            // For monthly and queries, only show active tenants
            const options = '<option value="">Choose a tenant...</option>' + tenantOptions;
            
            // For move out form, show all tenants (including moved out)
            const moveoutOptions = '<option value="">Choose a tenant...</option>' + allTenantOptions;
            
            // For queries, include General option
            const queryOptions = '<option value="">Select tenant...</option><option value="general">General (not tenant-specific)</option>' + tenantOptions;

            if (monthlySelect) monthlySelect.innerHTML = options;
            if (moveoutSelect) moveoutSelect.innerHTML = moveoutOptions;
            if (querySelect) querySelect.innerHTML = queryOptions;
        }

        // Delete functions
        function deleteTenant(id) {
            if (confirm('Are you sure you want to delete this tenant?')) {
                data.tenants = data.tenants.filter(t => t.id !== id);
                saveData();
                renderTenants();
                renderUnitsOverview();
                updateTenantSelects();
                showNotification('Tenant deleted');
            }
        }

        function deleteMonthly(id) {
            if (confirm('Are you sure you want to delete this payment?')) {
                data.monthly = data.monthly.filter(m => m.id !== id);
                saveData();
                renderMonthly();
                showNotification('Payment deleted');
            }
        }

        function deleteExpense(id) {
            if (confirm('Are you sure you want to delete this expense?')) {
                data.expenses = data.expenses.filter(e => e.id !== id);
                saveData();
                renderExpenses();
                showNotification('Expense deleted');
            }
        }

        function deleteMoveOut(id) {
            if (confirm('Are you sure you want to delete this move out record?')) {
                data.moveOuts = data.moveOuts.filter(m => m.id !== id);
                saveData();
                renderMoveOuts();
                showNotification('Move out deleted');
            }
        }

        // Set default dates
        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('monthlyDate').value = today;
            document.getElementById('expenseDate').value = today;
            document.getElementById('moveoutDate').value = today;
            document.getElementById('tenantSince').value = today;
        }

        // Update last saved
        function updateLastSaved() {
            const now = new Date().toLocaleTimeString();
            const lastSavedEl = document.getElementById('lastSaved');
            if (lastSavedEl) {
                lastSavedEl.textContent = 'Saved at ' + now;
            }
        }

        // Show save indicator
        function showSaveIndicator() {
            const statusDot = document.getElementById('statusDot');
            statusDot.style.background = '#10b981';
            setTimeout(() => {
                statusDot.style.background = '';
            }, 1000);
        }

        // Show notification
        function showNotification(message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-size: 14px;
                font-weight: 500;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // PWA initialization
        function initializePWA() {
            let deferredPrompt;
            
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                // Show install prompt
                const installPrompt = document.createElement('div');
                installPrompt.className = 'install-prompt';
                installPrompt.innerHTML = `
                    <h4>üì± Install Rental Manager</h4>
                    <p>Add this app to your home screen for quick access!</p>
                    <button class="btn btn-primary" onclick="installApp()">Install App</button>
                    <button class="btn btn-secondary" onclick="this.parentElement.remove()" style="margin-left: 8px;">Not Now</button>
                `;
                
                document.querySelector('.content-area').prepend(installPrompt);
            });
            
            window.installApp = async function() {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    deferredPrompt = null;
                    
                    // Remove install prompt
                    const prompt = document.querySelector('.install-prompt');
                    if (prompt) prompt.remove();
                    
                    if (outcome === 'accepted') {
                        showNotification('App installed successfully!');
                    }
                }
            };
        }

        // Online/offline status
        window.addEventListener('online', () => {
            document.getElementById('statusDot').classList.remove('offline');
            document.getElementById('statusText').textContent = 'Online';
        });

        window.addEventListener('offline', () => {
            document.getElementById('statusDot').classList.add('offline');
            document.getElementById('statusText').textContent = 'Offline';
        });

        // Summary functions
        function updateSummary() {
            // Ensure all arrays exist
            if (!data.monthly) data.monthly = [];
            if (!data.expenses) data.expenses = [];
            if (!data.moveOuts) data.moveOuts = [];
            
            const monthlyTotals = {};
            
            // Calculate monthly income
            data.monthly.forEach(record => {
                const month = record.date.substring(0, 7); // YYYY-MM
                monthlyTotals[month] = (monthlyTotals[month] || 0) + (parseFloat(record.amount) || 0);
            });

            // Calculate monthly expenses
            const expensesByMonth = {};
            data.expenses.forEach(expense => {
                const month = expense.date.substring(0, 7);
                expensesByMonth[month] = (expensesByMonth[month] || 0) + (parseFloat(expense.amount) || 0);
            });

            // Calculate totals
            let totalIncome = 0, totalExpenses = 0;
            Object.values(monthlyTotals).forEach(amount => totalIncome += amount);
            Object.values(expensesByMonth).forEach(amount => totalExpenses += amount);
            const totalNet = totalIncome - totalExpenses;

            // Update summary cards
            document.getElementById('summaryCards').innerHTML = `
                <div class="summary-card">
                    <h4>Total Income</h4>
                    <div class="summary-amount income">Ksh ${totalIncome.toFixed(2)}</div>
                </div>
                <div class="summary-card">
                    <h4>Total Expenses</h4>
                    <div class="summary-amount expense">Ksh ${totalExpenses.toFixed(2)}</div>
                </div>
                <div class="summary-card">
                    <h4>Net Income</h4>
                    <div class="summary-amount net">Ksh ${totalNet.toFixed(2)}</div>
                </div>
            `;

            // Create monthly breakdown table
            const allMonths = new Set([...Object.keys(monthlyTotals), ...Object.keys(expensesByMonth)]);
            const sortedMonths = Array.from(allMonths).sort().reverse();
            
            if (sortedMonths.length === 0) {
                document.getElementById('summaryTable').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìà</div>
                        <div class="empty-state-text">No data to summarize</div>
                        <div class="empty-state-subtext">Add tenants and payments to see reports</div>
                    </div>
                `;
                return;
            }

            const tableHTML = sortedMonths.map(month => {
                const income = monthlyTotals[month] || 0;
                const expenses = expensesByMonth[month] || 0;
                const net = income - expenses;
                const monthName = new Date(month + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                
                return `
                    <div class="entry-card">
                        <div class="entry-header">
                            <div class="entry-title">${monthName}</div>
                            <div class="entry-amount ${net >= 0 ? 'income' : 'expense'}">Ksh ${net.toFixed(2)}</div>
                        </div>
                        <div class="entry-details">
                            <div>Income: Ksh ${income.toFixed(2)}</div>
                            <div>Expenses: Ksh ${expenses.toFixed(2)}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('summaryTable').innerHTML = tableHTML;

            // Per-tenant summary
            const tenantListEl = document.getElementById('tenantSummaryList');
            if (tenantListEl) {
                if (!data.tenants || data.tenants.length === 0) {
                    tenantListEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üë•</div>
                            <div class="empty-state-text">No tenant data yet</div>
                            <div class="empty-state-subtext">Add tenants and payments to generate per-tenant summaries</div>
                        </div>
                    `;
                } else {
                    const tenantsHTML = data.tenants.map(tenant => {
                        const payments = (data.monthly || []).filter(p => String(p.tenantId) === String(tenant.id));
                        const totalPaid = payments.reduce((s, p) => s + (parseFloat(p.amount) || 0), 0);
                        const paymentsCount = payments.length;
                        const lastPaymentDate = payments.length ? payments.map(p => p.date).sort().reverse()[0] : null;
                        const moveOut = (data.moveOuts || []).find(m => String(m.tenantId) === String(tenant.id));
                        const depositReturned = moveOut ? (moveOut.depositReturned || 0) : null;

                        return `
                            <div class="entry-card" style="display: flex; flex-direction: column; gap: 8px;">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <div>
                                        <div style="font-weight:600;">${tenant.name} ${tenant.unit ? '‚Äî ' + tenant.unit : ''}</div>
                                        <div style="font-size:0.875rem; color:#64748b;">Rent: Ksh ${tenant.rent || '0'}</div>
                                    </div>
                                    <div style="display:flex; gap:8px; align-items:center;">
                                        <button class="btn btn-secondary btn-small" onclick="copyTenantSummary(${tenant.id})">Copy</button>
                                        <button class="btn btn-primary btn-small" onclick="shareTenantSummary(${tenant.id})">Share</button>
                                    </div>
                                </div>
                                <div style="color:#374151; font-size:0.95rem;">
                                    <div>Total Paid: Ksh ${totalPaid.toFixed(2)}</div>
                                    <div>Payments: ${paymentsCount}</div>
                                    <div>Last Payment: ${lastPaymentDate ? new Date(lastPaymentDate).toLocaleDateString() : 'N/A'}</div>
                                    ${depositReturned !== null ? `<div>Deposit Returned: Ksh ${depositReturned}</div>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');

                    tenantListEl.innerHTML = tenantsHTML;
                }
            }
        }

        // Helper: build tenant summary text (exclude payment type/notes)
        function buildTenantSummaryText(tenant) {
            const payments = (data.monthly || []).filter(p => String(p.tenantId) === String(tenant.id));
            const totalPaid = payments.reduce((s, p) => s + (parseFloat(p.amount) || 0), 0);
            const paymentsCount = payments.length;
            const lastPaymentDate = payments.length ? payments.map(p => p.date).sort().reverse()[0] : null;
            const moveOut = (data.moveOuts || []).find(m => String(m.tenantId) === String(tenant.id));
            const depositReturned = moveOut ? (moveOut.depositReturned || 0) : null;

            const lines = [];
            lines.push(`${tenant.name}${tenant.unit ? ' ‚Äî ' + tenant.unit : ''}`);
            lines.push(`Rent: Ksh ${tenant.rent || '0'}`);
            lines.push(`Total Paid: Ksh ${totalPaid.toFixed(2)}`);
            lines.push(`Payments Count: ${paymentsCount}`);
            lines.push(`Last Payment: ${lastPaymentDate ? new Date(lastPaymentDate).toLocaleDateString() : 'N/A'}`);
            if (depositReturned !== null) lines.push(`Deposit Returned: Ksh ${depositReturned}`);
            lines.push('Generated by Rental Manager');

            return lines.join('\n');
        }

        // Copy tenant summary to clipboard
        async function copyTenantSummary(id) {
            const tenant = (data.tenants || []).find(t => String(t.id) === String(id));
            if (!tenant) return showNotification('Tenant not found');
            const text = buildTenantSummaryText(tenant);
            try {
                await navigator.clipboard.writeText(text);
                showNotification('Tenant summary copied to clipboard');
            } catch (err) {
                console.error('Copy failed', err);
                alert(text);
            }
        }

        // Share tenant summary using Web Share API or fallback to copy
        async function shareTenantSummary(id) {
            const tenant = (data.tenants || []).find(t => String(t.id) === String(id));
            if (!tenant) return showNotification('Tenant not found');
            const text = buildTenantSummaryText(tenant);
            if (navigator.share) {
                try {
                    await navigator.share({ title: `${tenant.name} Summary`, text });
                    showNotification('Shared successfully');
                } catch (err) {
                    console.error('Share failed', err);
                    await copyTenantSummary(id);
                }
            } else {
                await copyTenantSummary(id);
            }
        }

        window.copyTenantSummary = copyTenantSummary;
        window.shareTenantSummary = shareTenantSummary;

        // Backup functions
        function updateBackupInfo() {
            const dataSize = JSON.stringify(data).length;
            const dataSizeKB = (dataSize / 1024).toFixed(2);
            const lastSaved = localStorage.getItem('lastSaved') || 'Never';
            const syncStatus = isOnline ? '‚úÖ Synced to cloud' : 'üîÑ Syncing locally';
            
            document.getElementById('lastBackup').textContent = lastSaved;
            document.getElementById('dataSize').textContent = `${dataSizeKB} KB`;
            const syncElement = document.getElementById('cloudSyncStatus');
            if (syncElement) {
                syncElement.textContent = syncStatus;
            }
        }

        function exportData() {
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `rental-manager-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showNotification('Data exported successfully!');
        }

        function exportCSV() {
            let csv = 'Type,Name/Description,Amount,Date,Notes\n';
            
            data.tenants.forEach(tenant => {
                csv += `Tenant,"${tenant.name}",${tenant.rent},${tenant.createdAt},"Unit: ${tenant.unit}"\n`;
            });
            
            data.monthly.forEach(payment => {
                const tenant = data.tenants.find(t => t.id == payment.tenantId);
                csv += `Payment,"${tenant ? tenant.name : 'Unknown'}",${payment.amount},${payment.date},"${payment.notes || ''}"\n`;
            });
            
            data.expenses.forEach(expense => {
                csv += `Expense,"${expense.description}",${expense.amount},${expense.date},"${expense.category}"\n`;
            });
            
            data.moveOuts.forEach(moveOut => {
                const tenant = data.tenants.find(t => t.id == moveOut.tenantId);
                csv += `Move Out,"${tenant ? tenant.name : 'Unknown'}",${moveOut.depositReturned || 0},${moveOut.date},"${moveOut.notes || ''}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `rental-manager-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(url);
            showNotification('CSV exported successfully!');
        }

        function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('Please select a file to import');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validate data structure - be flexible with missing fields
                    if (!importedData || typeof importedData !== 'object') {
                        throw new Error('File must contain valid JSON data');
                    }
                    
                    // Ensure all required arrays exist (create empty ones if missing)
                    const validData = {
                        tenants: importedData.tenants || [],
                        monthly: importedData.monthly || [],
                        expenses: importedData.expenses || [],
                        moveOuts: importedData.moveOuts || []
                    };
                    
                    // Check if any data exists
                    if (!validData.tenants.length && !validData.monthly.length && !validData.expenses.length && !validData.moveOuts.length) {
                        throw new Error('File contains no data');
                    }
                    
                    // Confirm import
                    if (confirm('This will replace all current data. Are you sure?')) {
                        data = validData;
                        saveData();
                        renderAllEntries();
                        updateTenantSelects();
                        showNotification('Data imported successfully! ' + validData.tenants.length + ' tenants, ' + validData.monthly.length + ' payments loaded.');
                        fileInput.value = ''; // Clear file input
                    }
                } catch (error) {
                    console.error('Import error:', error);
                    showNotification('Error: ' + error.message + '. Make sure you exported this from the Rental Manager app.');
                }
            };
            
            reader.readAsText(file);

        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è WARNING: This will delete ALL data permanently. Are you sure?')) {
                if (confirm('Last chance! Export a backup first if needed. Delete everything?')) {
                    data = {
                        tenants: [],
                        monthly: [],
                        expenses: [],
                        moveOuts: []
                    };
                    saveData();
                    renderAllEntries();
                    updateTenantSelects();
                    showNotification('All data cleared');
                }
            }
        }

        // Edit functions
        let tenantFormInitialState = '';
        let hasTenantFormChanged = false;

        // Monthly edit functions
        let monthlyFormInitialState = '';
        let hasMonthlyFormChanged = false;

        // Expense edit functions
        let expenseFormInitialState = '';
        let hasExpenseFormChanged = false;

        // Move out edit functions
        let moveOutFormInitialState = '';
        let hasMoveOutFormChanged = false;

        function captureMonthlyFormState() {
            // Use edit form if we're in edit mode, otherwise use regular form
            const form = document.getElementById('monthlyEditForm') || document.getElementById('monthlyForm');
            monthlyFormInitialState = JSON.stringify(
                Array.from(new FormData(form))
            );
        }

        function updateMonthlyFormButtons() {
            const cancelBtn = document.getElementById('monthlyCancelBtn');
            // Use edit form if it exists, otherwise use regular form
            const saveBtn = document.querySelector('#monthlyEditForm button[type="submit"]') || document.querySelector('#monthlyForm button[type="submit"]');
            
            // Cancel button is always enabled
            if (cancelBtn) {
                cancelBtn.disabled = false;
                cancelBtn.style.opacity = '1';
                cancelBtn.style.cursor = 'pointer';
            }
            
            // Update button only enabled when there are changes
            if (saveBtn) {
                saveBtn.disabled = !hasMonthlyFormChanged;
                saveBtn.style.opacity = hasMonthlyFormChanged ? '1' : '0.5';
                saveBtn.style.cursor = hasMonthlyFormChanged ? 'pointer' : 'not-allowed';
            }
        }

        function captureExpenseFormState() {
            const form = document.getElementById('expenseForm');
            expenseFormInitialState = JSON.stringify(
                Array.from(new FormData(form))
            );
        }

        function updateExpenseFormButtons() {
            const cancelBtn = document.getElementById('expenseCancelBtn');
            const saveBtn = document.querySelector('#expenseForm button[type="submit"]');
            
            // Cancel button is always enabled
            if (cancelBtn) {
                cancelBtn.disabled = false;
                cancelBtn.style.opacity = '1';
                cancelBtn.style.cursor = 'pointer';
            }
            
            // Update button only enabled when there are changes
            if (saveBtn) {
                saveBtn.disabled = !hasExpenseFormChanged;
                saveBtn.style.opacity = hasExpenseFormChanged ? '1' : '0.5';
                saveBtn.style.cursor = hasExpenseFormChanged ? 'pointer' : 'not-allowed';
            }
        }

        function captureMoveOutFormState() {
            const form = document.getElementById('moveoutForm');
            moveOutFormInitialState = JSON.stringify(
                Array.from(new FormData(form))
            );
        }

        function updateMoveOutFormButtons() {
            const cancelBtn = document.getElementById('moveOutCancelBtn');
            const saveBtn = document.querySelector('#moveoutForm button[type="submit"]');
            
            // Cancel button is always enabled
            if (cancelBtn) {
                cancelBtn.disabled = false;
                cancelBtn.style.opacity = '1';
                cancelBtn.style.cursor = 'pointer';
            }
            
            // Update button only enabled when there are changes
            if (saveBtn) {
                saveBtn.disabled = !hasMoveOutFormChanged;
                saveBtn.style.opacity = hasMoveOutFormChanged ? '1' : '0.5';
                saveBtn.style.cursor = hasMoveOutFormChanged ? 'pointer' : 'not-allowed';
            }
        }

        function captureTenantFormState() {
            const form = document.getElementById('tenantForm');
            tenantFormInitialState = JSON.stringify(
                Array.from(new FormData(form))
            );
        }

        function updateTenantFormButtons() {
            const cancelBtn = document.getElementById('tenantCancelBtn');
            const saveBtn = document.querySelector('#tenantForm button[type="submit"]');
            
            // Cancel button is always enabled
            if (cancelBtn) {
                cancelBtn.disabled = false;
                cancelBtn.style.opacity = '1';
                cancelBtn.style.cursor = 'pointer';
            }
            
            // Update button only enabled when there are changes
            if (saveBtn) {
                saveBtn.disabled = !hasTenantFormChanged;
                saveBtn.style.opacity = hasTenantFormChanged ? '1' : '0.5';
                saveBtn.style.cursor = hasTenantFormChanged ? 'pointer' : 'not-allowed';
            }
        }

        function editTenant(id) {
            const tenant = data.tenants.find(t => t.id === id);
            if (!tenant) return;
            
            // Store the original tenant data for validation and change detection
            window.editingTenantId = id;
            window.originalTenantData = {
                name: tenant.name,
                unit: tenant.unit,
                rent: tenant.rent,
                phone: tenant.phone || '',
                email: tenant.email || '',
                since: tenant.since || '',
                depositPaid: tenant.depositPaid || '',
                notes: tenant.notes || '',
                electricityMeter: tenant.electricityMeter || '',
                electricityBalance: tenant.electricityBalance || 0,
                waterMeter: tenant.waterMeter || '',
                waterBalance: tenant.waterBalance || 0,
                leaseDocuments: tenant.leaseDocuments || [],
                idDocuments: tenant.idDocuments || [],
                leaseDocument: tenant.leaseDocument || null,
                idDocument: tenant.idDocument || null
            };
            
            // Show overlay and lock background scroll
            document.getElementById('tenantEditOverlay').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            // Fill form with tenant data
            document.getElementById('tenantName').value = tenant.name;
            document.getElementById('tenantUnit').value = tenant.unit;
            document.getElementById('tenantRent').value = tenant.rent;
            document.getElementById('tenantPhone').value = tenant.phone || '';
            document.getElementById('tenantEmail').value = tenant.email || '';
            document.getElementById('tenantSince').value = tenant.since || '';
            document.getElementById('depositPaid').value = tenant.depositPaid || '';
            document.getElementById('tenantNotes').value = tenant.notes || '';
            document.getElementById('electricityMeter').value = tenant.electricityMeter || '';
            document.getElementById('electricityBalance').value = tenant.electricityBalance || '';
            document.getElementById('waterMeter').value = tenant.waterMeter || '';
            document.getElementById('waterBalance').value = tenant.waterBalance || '';
            
            // CRITICAL: Capture baseline immediately after form population
            hasTenantFormChanged = false;
            captureTenantFormState();
            updateTenantFormButtons();
            
            // Display existing documents
            const leaseDisplay = document.getElementById('leaseDocumentDisplay');
            const idDisplay = document.getElementById('tenantIdDocumentDisplay');
            
            // Show lease document if exists
            if (tenant.leaseDocuments && tenant.leaseDocuments.length > 0) {
                // Show individual lease files with X buttons
                let leaseFilesHtml = '<div style="margin-top: 8px;">';
                tenant.leaseDocuments.forEach((doc, index) => {
                    leaseFilesHtml += `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 4px 8px; background: #f8fafc; border-radius: 4px; margin-bottom: 4px;">
                            <span style="font-size: 0.875rem; color: #374151;">${doc.name}</span>
                            <button type="button" onclick="removeLeaseDocument(${index})" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 2px; font-size: 16px;">√ó</button>
                        </div>
                    `;
                });
                leaseFilesHtml += '</div>';
                leaseDisplay.innerHTML = leaseFilesHtml;
                
                // Create Upload button with correct state based on count
                let leaseBtnState = '';
                let leaseBtnText = 'Upload';
                if (tenant.leaseDocuments.length >= 3) {
                    leaseBtnState = 'disabled style="opacity: 0.5; cursor: not-allowed;"';
                    leaseBtnText = 'Max 3 files';
                }
                document.getElementById('leaseDocumentButtons').innerHTML = `<button type="button" id="leaseUploadBtn" class="btn btn-secondary" onclick="document.getElementById(\'leaseDocument\').click()" style="flex: 1;" ${leaseBtnState}>${leaseBtnText}</button>`;
            } else if (tenant.leaseDocument) {
                // Show single file with X button (backward compatibility)
                leaseDisplay.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 4px 8px; background: #f8fafc; border-radius: 4px; margin-top: 4px;">
                        <span style="font-size: 0.875rem; color: #374151;">${tenant.leaseDocument.name}</span>
                        <button type="button" onclick="removeLeaseDocument(0)" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 2px; font-size: 16px;">√ó</button>
                    </div>
                `;
                
                // Show Upload button (enabled for single file)
                document.getElementById('leaseDocumentButtons').innerHTML = '<button type="button" id="leaseUploadBtn" class="btn btn-secondary" onclick="document.getElementById(\'leaseDocument\').click()" style="flex: 1;">Upload</button>';
            } else {
                leaseDisplay.innerHTML = '<span style="color: #64748b;">No documents uploaded</span>';
                document.getElementById('leaseDocumentButtons').innerHTML = '<button type="button" id="leaseUploadBtn" class="btn btn-secondary" onclick="document.getElementById(\'leaseDocument\').click()" style="flex: 1;">Upload</button>';
            }
            
            // Show ID documents if exist (handle both old single and new multiple format)
            const idButtonsContainer = document.getElementById('idDocumentButtons');
            if (tenant.idDocuments && tenant.idDocuments.length > 0) {
                // Show individual files with X buttons
                let filesHtml = '<div style="margin-top: 8px;">';
                tenant.idDocuments.forEach((doc, index) => {
                    filesHtml += `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 4px 8px; background: #f8fafc; border-radius: 4px; margin-bottom: 4px;">
                            <span style="font-size: 0.875rem; color: #374151;">${doc.name}</span>
                            <button type="button" onclick="removeIdDocument(${index})" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 2px; font-size: 16px;">√ó</button>
                        </div>
                    `;
                });
                filesHtml += '</div>';
                idDisplay.innerHTML = filesHtml;
                
                // Create Upload button with correct state based on count
                let idBtnState = '';
                let idBtnText = 'Upload';
                if (tenant.idDocuments.length >= 3) {
                    idBtnState = 'disabled style="opacity: 0.5; cursor: not-allowed;"';
                    idBtnText = 'Max 3 files';
                }
                idButtonsContainer.innerHTML = `<button type="button" id="idUploadBtn" class="btn btn-secondary" onclick="document.getElementById(\'tenantIdDocument\').click()" style="flex: 1;" ${idBtnState}>${idBtnText}</button>`;
                window.idDocumentMode = 'add'; // Always add mode when documents exist
            } else if (tenant.idDocument) {
                // Show single file with X button
                idDisplay.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 4px 8px; background: #f8fafc; border-radius: 4px; margin-top: 4px;">
                        <span style="font-size: 0.875rem; color: #374151;">${tenant.idDocument.name}</span>
                        <button type="button" onclick="removeSingleIdDocument()" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 2px; font-size: 16px;">√ó</button>
                    </div>
                `;
                
                // Show Upload button (enabled for single file)
                idButtonsContainer.innerHTML = '<button type="button" id="idUploadBtn" class="btn btn-secondary" onclick="document.getElementById(\'tenantIdDocument\').click()" style="flex: 1;">Upload</button>';
                window.idDocumentMode = 'add'; // Always add mode when documents exist
            } else {
                idDisplay.innerHTML = '<span style="color: #64748b;">No documents uploaded</span>';
                idButtonsContainer.innerHTML = '<button type="button" id="idUploadBtn" class="btn btn-secondary" onclick="document.getElementById(\'tenantIdDocument\').click()" style="flex: 1;">Upload</button>';
                window.idDocumentMode = 'new'; // New upload mode
            }
            
            // Change save button text
            const saveBtn = document.querySelector('#tenantForm button[type="submit"]');
            saveBtn.textContent = 'Update Tenant';
            
            // Change form heading
            document.getElementById('tenantFormTitle').textContent = 'Edit Tenant';
            
            // Show cancel button
            document.getElementById('tenantCancelBtn').style.display = 'block';
            
            showNotification('Edit tenant details and save to update');
        }

        // Function to cancel tenant edit
        function cancelTenantEdit() {
            if (window.editingTenantId) {
                // Check if there are unsaved changes
                const hasChanges = !document.querySelector('#tenantForm button[type="submit"]').disabled;
                
                if (hasChanges) {
                    if (!confirm('You have unsaved changes. Are you sure you want to cancel?')) {
                        return;
                    }
                }
                
                // Reset editing state
                window.editingTenantId = null;
                window.originalTenantData = null;
            }
            
            // Reset form
            document.getElementById('tenantForm').reset();
            
            // Reset form heading
            document.getElementById('tenantFormTitle').textContent = 'Add New Tenant';
            
            // Reset save button text and state
            const saveBtn = document.querySelector('#tenantForm button[type="submit"]');
            saveBtn.textContent = 'Save Tenant';
            saveBtn.disabled = false;
            saveBtn.style.opacity = '1';
            saveBtn.style.cursor = 'pointer';
            
            // Hide cancel button
            document.getElementById('tenantCancelBtn').style.display = 'none';
            
            // Reset document displays
            document.getElementById('leaseDocumentDisplay').innerHTML = '';
            document.getElementById('tenantIdDocumentDisplay').innerHTML = '';
            
            // Reset button states
            document.getElementById('leaseUploadBtn').textContent = 'Upload';
            document.getElementById('leaseUploadBtn').className = 'btn btn-secondary';
            
            // Reset ID document buttons
            document.getElementById('idDocumentButtons').innerHTML = '<button type="button" id="idUploadBtn" class="btn btn-secondary" onclick="document.getElementById(\'tenantIdDocument\').click()" style="flex: 1;">Upload</button>';
            
            // Reset lease document buttons
            document.getElementById('leaseDocumentButtons').innerHTML = '<button type="button" id="leaseUploadBtn" class="btn btn-secondary" onclick="document.getElementById(\'leaseDocument\').click()" style="flex: 1;">Upload</button>';
            
            // Clear accumulated files
            window.existingLeaseFiles = [];
            window.existingIdFiles = [];
            
            window.idDocumentMode = 'new';
            
            // Hide overlay and restore background scroll
            document.getElementById('tenantEditOverlay').classList.add('hidden');
            document.body.style.overflow = '';
            
            showNotification('Edit cancelled');
        }

        // Function to check for changes and enable/disable update button
        function checkForChanges() {
            if (!window.editingTenantId || !window.originalTenantData) {
                return;
            }
            
            const saveBtn = document.querySelector('#tenantForm button[type="submit"]');
            
            // Get current form values
            const currentData = {
                name: document.getElementById('tenantName').value.trim(),
                unit: document.getElementById('tenantUnit').value.trim(),
                rent: document.getElementById('tenantRent').value,
                phone: document.getElementById('tenantPhone').value.trim(),
                email: document.getElementById('tenantEmail').value.trim(),
                since: document.getElementById('tenantSince').value,
                depositPaid: document.getElementById('depositPaid').value,
                notes: document.getElementById('tenantNotes').value.trim(),
                electricityMeter: document.getElementById('electricityMeter').value.trim(),
                electricityBalance: parseFloat(document.getElementById('electricityBalance').value) || 0,
                waterMeter: document.getElementById('waterMeter').value.trim(),
                waterBalance: parseFloat(document.getElementById('waterBalance').value) || 0
            };
            
            // Get current files
            const leaseFiles = document.getElementById('leaseDocument').files;
            const idFiles = document.getElementById('tenantIdDocument').files;
            
            // Check if any field has changed
            let hasChanges = false;
            
            // Check text fields
            for (const key in currentData) {
                if (currentData[key] !== window.originalTenantData[key]) {
                    hasChanges = true;
                    break;
                }
            }
            
            // Check files if no text changes found
            if (!hasChanges) {
                // Check lease documents
                const currentLeaseDocs = Array.from(leaseFiles).map(f => ({
                    name: f.name,
                    size: f.size,
                    type: f.type,
                    lastModified: f.lastModified
                }));
                
                const originalLeaseDocs = window.originalTenantData.leaseDocuments || [];
                const originalLeaseDoc = window.originalTenantData.leaseDocument;
                
                if (originalLeaseDoc && !originalLeaseDocs.length) {
                    originalLeaseDocs.push(originalLeaseDoc);
                }
                
                if (currentLeaseDocs.length !== originalLeaseDocs.length) {
                    hasChanges = true;
                } else {
                    for (let i = 0; i < currentLeaseDocs.length; i++) {
                        if (currentLeaseDocs[i].name !== originalLeaseDocs[i]?.name ||
                            currentLeaseDocs[i].size !== originalLeaseDocs[i]?.size) {
                            hasChanges = true;
                            break;
                        }
                    }
                }
            }
            
            // Check ID documents if no changes found yet
            if (!hasChanges) {
                const currentIdDocs = Array.from(idFiles).map(f => ({
                    name: f.name,
                    size: f.size,
                    type: f.type,
                    lastModified: f.lastModified
                }));
                
                const originalIdDocs = window.originalTenantData.idDocuments || [];
                const originalIdDoc = window.originalTenantData.idDocument;
                
                if (originalIdDoc && !originalIdDocs.length) {
                    originalIdDocs.push(originalIdDoc);
                }
                
                if (currentIdDocs.length !== originalIdDocs.length) {
                    hasChanges = true;
                } else {
                    for (let i = 0; i < currentIdDocs.length; i++) {
                        if (currentIdDocs[i].name !== originalIdDocs[i]?.name ||
                            currentIdDocs[i].size !== originalIdDocs[i]?.size) {
                            hasChanges = true;
                            break;
                        }
                    }
                }
            }
            
            // Update button state
            if (hasChanges) {
                saveBtn.disabled = false;
                saveBtn.classList.remove('btn-disabled');
                saveBtn.style.opacity = '1';
                saveBtn.style.cursor = 'pointer';
            } else {
                saveBtn.disabled = true;
                saveBtn.classList.add('btn-disabled');
                saveBtn.style.opacity = '0.5';
                saveBtn.style.cursor = 'not-allowed';
            }
        }

        function editMonthly(id) {
            const payment = data.monthly.find(p => p.id === id);
            if (!payment) return;
            
            // Store the original payment data for validation and change detection
            window.editingMonthlyId = id;
            window.originalMonthlyData = {
                tenantId: payment.tenantId,
                amount: payment.amount,
                date: payment.date,
                notes: payment.notes || ''
            };
            
            // Show overlay and lock background scroll
            document.getElementById('monthlyEditOverlay').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            // Fill form with payment data
            document.getElementById('monthlyTenantEdit').value = payment.tenantId;
            document.getElementById('monthlyAmountEdit').value = payment.amount;
            document.getElementById('monthlyDateEdit').value = payment.date;
            document.getElementById('monthlyNotesEdit').value = payment.notes || '';
            
            // Reset edit state and capture baseline
            hasMonthlyFormChanged = false;
            captureMonthlyFormState();
            updateMonthlyFormButtons();
            
            // Change save button text
            const saveBtn = document.querySelector('#monthlyEditForm button[type="submit"]');
            saveBtn.textContent = 'Update Payment';
            
            // Change form heading
            document.getElementById('monthlyFormTitle').textContent = 'Edit Monthly Payment';
            
            // Show cancel button
            document.getElementById('monthlyCancelBtn').style.display = 'block';
            
            showNotification('Edit payment details and save to update');
        }

        // Function to cancel monthly edit
        function cancelMonthlyEdit() {
            if (window.editingMonthlyId) {
                // Check if there are unsaved changes
                const hasChanges = !document.querySelector('#monthlyForm button[type="submit"]').disabled;
                
                if (hasChanges) {
                    if (!confirm('You have unsaved changes. Are you sure you want to cancel?')) {
                        return;
                    }
                }
                
                // Reset editing state
                window.editingMonthlyId = null;
                window.originalMonthlyData = null;
            }
            
            // Reset form
            document.getElementById('monthlyForm').reset();
            
            // Reset form heading
            document.getElementById('monthlyFormTitle').textContent = 'Record Monthly Payment';
            
            // Reset save button text and state
            const saveBtn = document.querySelector('#monthlyForm button[type="submit"]');
            saveBtn.textContent = 'Record Payment';
            saveBtn.disabled = false;
            saveBtn.style.opacity = '1';
            saveBtn.style.cursor = 'pointer';
            
            // Hide cancel button
            document.getElementById('monthlyCancelBtn').style.display = 'none';
            
            // Hide overlay and restore background scroll
            document.getElementById('monthlyEditOverlay').classList.add('hidden');
            document.body.style.overflow = '';
            
            showNotification('Edit cancelled');
        }

        function editExpense(id) {
            const expense = data.expenses.find(e => e.id === id);
            if (!expense) return;
            
            // Store the original expense data for validation and change detection
            window.editingExpenseId = id;
            window.originalExpenseData = {
                category: expense.category,
                description: expense.description,
                reference: expense.reference || '',
                amount: expense.amount,
                date: expense.date
            };
            
            // Show overlay and lock background scroll
            document.getElementById('expenseEditOverlay').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            // Fill form with expense data
            document.getElementById('expenseCategory').value = expense.category;
            document.getElementById('expenseDescription').value = expense.description;
            document.getElementById('expenseReference').value = expense.reference || '';
            document.getElementById('expenseAmount').value = expense.amount;
            document.getElementById('expenseDate').value = expense.date;
            
            // Reset edit state and capture baseline
            hasExpenseFormChanged = false;
            captureExpenseFormState();
            updateExpenseFormButtons();
            
            // Change save button text
            const saveBtn = document.querySelector('#expenseForm button[type="submit"]');
            saveBtn.textContent = 'Update Expense';
            
            // Change form heading
            document.getElementById('expenseFormTitle').textContent = 'Edit Expense';
            
            // Show cancel button
            document.getElementById('expenseCancelBtn').style.display = 'block';
            
            showNotification('Edit expense details and save to update');
        }

        // Function to cancel expense edit
        function cancelExpenseEdit() {
            if (window.editingExpenseId) {
                // Check if there are unsaved changes
                const hasChanges = !document.querySelector('#expenseForm button[type="submit"]').disabled;
                
                if (hasChanges) {
                    if (!confirm('You have unsaved changes. Are you sure you want to cancel?')) {
                        return;
                    }
                }
                
                // Reset editing state
                window.editingExpenseId = null;
                window.originalExpenseData = null;
            }
            
            // Reset form
            document.getElementById('expenseForm').reset();
            
            // Reset form heading
            document.getElementById('expenseFormTitle').textContent = 'Add Expense';
            
            // Reset save button text and state
            const saveBtn = document.querySelector('#expenseForm button[type="submit"]');
            saveBtn.textContent = 'Add Expense';
            saveBtn.disabled = false;
            saveBtn.style.opacity = '1';
            saveBtn.style.cursor = 'pointer';
            
            // Hide cancel button
            document.getElementById('expenseCancelBtn').style.display = 'none';
            
            // Hide overlay and restore background scroll
            document.getElementById('expenseEditOverlay').classList.add('hidden');
            document.body.style.overflow = '';
            
            showNotification('Edit cancelled');
        }

        function editMoveOut(id) {
            const moveOut = data.moveOuts.find(m => m.id === id);
            if (!moveOut) return;
            
            // Store the original move out data for validation and change detection
            window.editingMoveOutId = id;
            window.originalMoveOutData = {
                tenantId: moveOut.tenantId,
                date: moveOut.date,
                depositReturned: moveOut.depositReturned || '',
                notes: moveOut.notes || ''
            };
            
            // Show overlay and lock background scroll
            document.getElementById('moveOutEditOverlay').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            // Fill form with move out data
            document.getElementById('moveoutTenant').value = moveOut.tenantId;
            document.getElementById('moveoutDate').value = moveOut.date;
            document.getElementById('depositReturned').value = moveOut.depositReturned || '';
            document.getElementById('moveoutNotes').value = moveOut.notes || '';
            
            // Reset edit state and capture baseline
            hasMoveOutFormChanged = false;
            captureMoveOutFormState();
            updateMoveOutFormButtons();
            
            // Change save button text
            const saveBtn = document.querySelector('#moveoutForm button[type="submit"]');
            saveBtn.textContent = 'Update Move Out';
            
            // Change form heading
            document.getElementById('moveOutFormTitle').textContent = 'Edit Move Out';
            
            // Show cancel button
            document.getElementById('moveOutCancelBtn').style.display = 'block';
            
            showNotification('Edit move out details and save to update');
        }

        // Function to cancel move out edit
        function cancelMoveOutEdit() {
            if (window.editingMoveOutId) {
                // Check if there are unsaved changes
                const hasChanges = !document.querySelector('#moveoutForm button[type="submit"]').disabled;
                
                if (hasChanges) {
                    if (!confirm('You have unsaved changes. Are you sure you want to cancel?')) {
                        return;
                    }
                }
                
                // Reset editing state
                window.editingMoveOutId = null;
                window.originalMoveOutData = null;
            }
            
            // Reset form
            document.getElementById('moveoutForm').reset();
            
            // Reset form heading
            document.getElementById('moveOutFormTitle').textContent = 'Record Move Out';
            
            // Reset save button text and state
            const saveBtn = document.querySelector('#moveoutForm button[type="submit"]');
            saveBtn.textContent = 'Record Move Out';
            saveBtn.disabled = false;
            saveBtn.style.opacity = '1';
            saveBtn.style.cursor = 'pointer';
            
            // Hide cancel button
            document.getElementById('moveOutCancelBtn').style.display = 'none';
            
            // Hide overlay and restore background scroll
            document.getElementById('moveOutEditOverlay').classList.add('hidden');
            document.body.style.overflow = '';
            
            showNotification('Edit cancelled');
        }

        // Tenant Queries: add, render, toggle resolved, delete
        function addQuery() {
            if (!data.queries) data.queries = [];
            const tenantId = document.getElementById('queryTenant').value;
            const date = document.getElementById('queryDate').value || new Date().toISOString().split('T')[0];
            const issue = document.getElementById('queryIssue').value || '';
            const action = document.getElementById('queryAction').value || '';
            const resolved = document.getElementById('queryResolved').value === 'true';

            if (!tenantId) {
                showNotification('Please select a tenant for the query');
                return;
            }

            const q = {
                id: window.editingQueryId || Date.now(),
                tenantId: tenantId,
                date: date,
                issue: issue,
                action: action,
                resolved: resolved,
                createdAt: new Date().toISOString()
            };

            if (window.editingQueryId) {
                // Update existing query
                const index = data.queries.findIndex(query => query.id === window.editingQueryId);
                if (index !== -1) {
                    data.queries[index] = q;
                    showNotification('Query updated successfully!');
                }
                window.editingQueryId = null;
            } else {
                // Add new query
                data.queries.push(q);
                showNotification('Query logged');
            }

            saveData();
            renderQueries();
            
            // Reset form and button state
            document.getElementById('queryForm').reset();
            
            const saveBtn = document.querySelector('#queryForm button[type="submit"]');
            if (saveBtn) {
                saveBtn.textContent = 'Add Query';
            }
            
            // Remove cancel button
            const cancelBtn = document.getElementById('queryCancelBtn');
            if (cancelBtn) {
                cancelBtn.remove();
            }
        }

        function renderQueries() {
            const container = document.getElementById('queriesList');
            if (!container) return;
            if (!data.queries || data.queries.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <div class="empty-state-text">No queries yet</div>
                        <div class="empty-state-subtext">Tenant queries will appear here</div>
                    </div>
                `;
                return;
            }

            const tenantsById = (data.tenants || []).reduce((acc, t) => { acc[t.id] = t; return acc; }, {});

            container.innerHTML = data.queries.slice().reverse().map(q => `
                <div class="entry-card" style="display:flex; flex-direction:column; gap:8px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="font-weight:600;">${q.tenantId === 'general' ? 'General (not tenant-specific)' : (tenantsById[q.tenantId] ? tenantsById[q.tenantId].name + (tenantsById[q.tenantId].unit ? ' ‚Äî ' + tenantsById[q.tenantId].unit : '') : 'Unknown Tenant')}</div>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <div style="font-size:0.85rem; color:#64748b;">${new Date(q.date).toLocaleDateString()}</div>
                            <button class="btn btn-small ${q.resolved ? 'btn-success' : 'btn-secondary'}" onclick="toggleQueryResolved(${q.id})">${q.resolved ? 'Resolved' : 'Mark Resolved'}</button>
                            <button class="btn btn-small btn-secondary" onclick="editQuery(${q.id})">Edit</button>
                            <button class="btn btn-small btn-danger" onclick="deleteQuery(${q.id})">Delete</button>
                        </div>
                    </div>
                    <div style="color:#374151;">Issue: ${q.issue || '‚Äî'}</div>
                    <div style="color:#374151;">Action: ${q.action || '‚Äî'}</div>
                </div>
            `).join('');
        }

        function toggleQueryResolved(id) {
            const q = data.queries.find(x => x.id === id);
            if (!q) return;
            q.resolved = !q.resolved;
            saveData();
            renderQueries();
            showNotification(q.resolved ? 'Query marked resolved' : 'Query marked unresolved');
        }

        function deleteQuery(id) {
            if (!confirm('Delete this query?')) return;
            data.queries = (data.queries || []).filter(q => q.id !== id);
            saveData();
            renderQueries();
            showNotification('Query deleted');
        }

        function editQuery(id) {
            const query = data.queries.find(q => q.id === id);
            if (!query) return;
            
            // Fill form with query data
            document.getElementById('queryTenant').value = query.tenantId || '';
            document.getElementById('queryDate').value = query.date || '';
            document.getElementById('queryIssue').value = query.issue || '';
            document.getElementById('queryAction').value = query.action || '';
            document.getElementById('queryResolved').value = query.resolved ? 'true' : 'false';
            
            // Store the query ID for update
            window.editingQueryId = id;
            
            // Change save button text
            const saveBtn = document.querySelector('#queryForm button[type="submit"]');
            if (saveBtn) {
                saveBtn.textContent = 'Update Query';
            }
            
            // Add cancel button if it doesn't exist
            let cancelBtn = document.getElementById('queryCancelBtn');
            if (!cancelBtn) {
                cancelBtn = document.createElement('button');
                cancelBtn.id = 'queryCancelBtn';
                cancelBtn.type = 'button';
                cancelBtn.className = 'btn btn-secondary';
                cancelBtn.textContent = 'Cancel';
                cancelBtn.onclick = cancelQueryEdit;
                
                const formActions = document.querySelector('#queryForm .form-actions');
                if (formActions) {
                    formActions.insertBefore(cancelBtn, formActions.firstChild);
                }
            }
            
            // Scroll to form
            document.getElementById('queryForm').scrollIntoView({ behavior: 'smooth' });
            
            showNotification('Edit query details and save to update');
        }

        function cancelQueryEdit() {
            // Reset form
            document.getElementById('queryForm').reset();
            
            // Reset save button text
            const saveBtn = document.querySelector('#queryForm button[type="submit"]');
            if (saveBtn) {
                saveBtn.textContent = 'Add Query';
            }
            
            // Remove cancel button
            const cancelBtn = document.getElementById('queryCancelBtn');
            if (cancelBtn) {
                cancelBtn.remove();
            }
            
            // Clear editing state
            window.editingQueryId = null;
            
            showNotification('Edit cancelled');
        }

        // Expose query functions
        window.addQuery = addQuery;
        window.renderQueries = renderQueries;
        window.toggleQueryResolved = toggleQueryResolved;
        window.editQuery = editQuery;
        window.deleteQuery = deleteQuery;
        window.editProperty = editProperty;
        window.cancelPropertyEdit = cancelPropertyEdit;
        window.updateProperty = updateProperty;
        window.backToProperties = backToProperties;
        window.selectProperty = selectProperty;
        window.cancelQueryEdit = cancelQueryEdit;

        // User menu functions
        window.toggleUserMenu = toggleUserMenu;
        window.closeUserMenu = closeUserMenu;
        window.showBackupSection = showBackupSection;

        // User menu functions
        function toggleUserMenu() {
            const slideout = document.querySelector('.user-slideout');
            const overlay = document.querySelector('.slideout-overlay');
            slideout.classList.add('active');
            overlay.classList.add('active');
            updateSlideoutUserInfo();
        }

        function closeUserMenu() {
            const slideout = document.querySelector('.user-slideout');
            const overlay = document.querySelector('.slideout-overlay');
            slideout.classList.remove('active');
            overlay.classList.remove('active');
        }

        function showBackupSection() {
            // Switch to backup tab
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            
            const backupTab = document.querySelector('[onclick*="backup"]');
            const backupContent = document.getElementById('backup');
            
            if (backupTab) backupTab.classList.add('active');
            if (backupContent) backupContent.classList.add('active');
        }

        function updateSlideoutUserInfo() {
            const userNameElement = document.getElementById('slideoutUserName');
            const userEmailElement = document.getElementById('slideoutUserEmail');
            
            if (currentUser && userNameElement && userEmailElement) {
                userNameElement.textContent = currentUser.displayName || 'User';
                userEmailElement.textContent = currentUser.email || 'user@example.com';
            }
        }

        // Splash screen functions
        function hideSplash() {
            const splashContainer = document.getElementById('splashContainer');
            splashContainer.classList.add('hidden');
            setTimeout(() => {
                splashContainer.style.display = 'none';
            }, 500);
        }

        // Auto-hide splash after 5 seconds if user doesn't interact
        setTimeout(() => {
            const splashContainer = document.getElementById('splashContainer');
            if (splashContainer && !splashContainer.classList.contains('hidden')) {
                hideSplash();
            }
        }, 5000);

        // Document management functions
        function removeIdDocument(index) {
            const tenant = data.tenants.find(t => t.id === window.editingTenantId);
            if (tenant && tenant.idDocuments) {
                tenant.idDocuments.splice(index, 1);
                
                // Update change state
                hasTenantFormChanged = true;
                updateTenantFormButtons();
                
                // Refresh the display without re-populating the form
                const idDisplay = document.getElementById('tenantIdDocumentDisplay');
                if (tenant.idDocuments.length > 0) {
                    let filesHtml = '<div style="margin-top: 8px;">';
                    tenant.idDocuments.forEach((doc, idx) => {
                        filesHtml += `
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 4px 8px; background: #f8fafc; border-radius: 4px; margin-bottom: 4px;">
                                <span style="font-size: 0.875rem; color: #374151;">${doc.name}</span>
                                <button type="button" onclick="removeIdDocument(${idx})" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 2px; font-size: 16px;">√ó</button>
                            </div>
                        `;
                    });
                    filesHtml += '</div>';
                    idDisplay.innerHTML = filesHtml;
                } else {
                    idDisplay.innerHTML = '<span style="color: #64748b;">No documents uploaded</span>';
                }
                
                // Update upload button state
                const uploadBtn = document.getElementById('idUploadBtn');
                if (tenant.idDocuments.length < 3) {
                    uploadBtn.disabled = false;
                    uploadBtn.style.opacity = '1';
                    uploadBtn.style.cursor = 'pointer';
                    uploadBtn.textContent = 'Upload';
                }
                
                showNotification('Document removed. Save tenant to apply changes.');
            }
        }

        function removeSingleIdDocument() {
            const tenant = data.tenants.find(t => t.id === window.editingTenantId);
            if (tenant) {
                tenant.idDocument = null;
                tenant.idDocuments = [];
                
                // Update change state
                hasTenantFormChanged = true;
                updateTenantFormButtons();
                
                // Refresh the display without re-populating the form
                document.getElementById('tenantIdDocumentDisplay').innerHTML = '<span style="color: #64748b;">No documents uploaded</span>';
                
                // Update upload button state
                const uploadBtn = document.getElementById('idUploadBtn');
                uploadBtn.disabled = false;
                uploadBtn.style.opacity = '1';
                uploadBtn.style.cursor = 'pointer';
                uploadBtn.textContent = 'Upload';
                
                showNotification('Document removed. Save tenant to apply changes.');
            }
        }

        function removeNewFile(index) {
            console.log('removeNewFile called with index:', index);
            if (!confirm('Are you sure you want to remove this file?')) {
                return;
            }
            
            const fileInput = document.getElementById('tenantIdDocument');
            const dt = new DataTransfer();
            
            // Add all files except the one being removed
            const currentFiles = Array.from(fileInput.files);
            console.log('Current files before removal:', currentFiles.length);
            for (let i = 0; i < currentFiles.length; i++) {
                if (i !== index) {
                    dt.items.add(currentFiles[i]);
                }
            }
            
            // Update the file input
            fileInput.files = dt.files;
            
            // Update the stored files array
            window.existingIdFiles = Array.from(dt.files);
            console.log('Files after removal:', dt.files.length);
            
            // Update display directly
            if (dt.files.length === 0) {
                document.getElementById('tenantIdDocumentDisplay').innerHTML = '';
            } else {
                let filesHtml = '<div style="margin-top: 8px;">';
                for (let i = 0; i < dt.files.length; i++) {
                    filesHtml += `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 4px 8px; background: #f8fafc; border-radius: 4px; margin-bottom: 4px;">
                            <span style="font-size: 0.875rem; color: #374151;">${dt.files[i].name}</span>
                            <button type="button" onclick="removeNewFile(${i})" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 2px; font-size: 16px;">√ó</button>
                        </div>
                    `;
                }
                filesHtml += '</div>';
                document.getElementById('tenantIdDocumentDisplay').innerHTML = filesHtml;
            }
            
            // Update upload button state
            const uploadBtn = document.getElementById('idUploadBtn');
            if (dt.files.length < 3) {
                uploadBtn.disabled = false;
                uploadBtn.style.opacity = '1';
                uploadBtn.style.cursor = 'pointer';
                uploadBtn.textContent = 'Upload';
            }
            
            // Update change state
            if (window.editingTenantId) {
                hasTenantFormChanged = true;
                updateTenantFormButtons();
            }
        }

        function removeNewLeaseFile(index) {
            console.log('removeNewLeaseFile called with index:', index);
            if (!confirm('Are you sure you want to remove this file?')) {
                return;
            }
            
            const fileInput = document.getElementById('leaseDocument');
            const dt = new DataTransfer();
            
            // Add all files except the one being removed
            const currentFiles = Array.from(fileInput.files);
            console.log('Current lease files before removal:', currentFiles.length);
            for (let i = 0; i < currentFiles.length; i++) {
                if (i !== index) {
                    dt.items.add(currentFiles[i]);
                }
            }
            
            // Update the file input
            fileInput.files = dt.files;
            
            // Update the stored files array
            window.existingLeaseFiles = Array.from(dt.files);
            console.log('Lease files after removal:', dt.files.length);
            
            // Update display directly
            if (dt.files.length === 0) {
                document.getElementById('leaseDocumentDisplay').innerHTML = '';
            } else {
                let filesHtml = '<div style="margin-top: 8px;">';
                for (let i = 0; i < dt.files.length; i++) {
                    filesHtml += `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 4px 8px; background: #f8fafc; border-radius: 4px; margin-bottom: 4px;">
                            <span style="font-size: 0.875rem; color: #374151;">${dt.files[i].name}</span>
                            <button type="button" onclick="removeNewLeaseFile(${i})" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 2px; font-size: 16px;">√ó</button>
                        </div>
                    `;
                }
                filesHtml += '</div>';
                document.getElementById('leaseDocumentDisplay').innerHTML = filesHtml;
            }
            
            // Update upload button state
            const uploadBtn = document.getElementById('leaseUploadBtn');
            if (dt.files.length < 3) {
                uploadBtn.disabled = false;
                uploadBtn.style.opacity = '1';
                uploadBtn.style.cursor = 'pointer';
                uploadBtn.textContent = 'Upload';
            }
            
            // Update change state
            if (window.editingTenantId) {
                hasTenantFormChanged = true;
                updateTenantFormButtons();
            }
        }

        function removeLeaseDocument(index) {
            const tenant = data.tenants.find(t => t.id === window.editingTenantId);
            if (tenant && tenant.leaseDocuments) {
                tenant.leaseDocuments.splice(index, 1);
                
                // Update change state
                hasTenantFormChanged = true;
                updateTenantFormButtons();
                
                // Refresh the display without re-populating the form
                const leaseDisplay = document.getElementById('leaseDocumentDisplay');
                if (tenant.leaseDocuments.length > 0) {
                    let leaseFilesHtml = '<div style="margin-top: 8px;">';
                    tenant.leaseDocuments.forEach((doc, idx) => {
                        leaseFilesHtml += `
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 4px 8px; background: #f8fafc; border-radius: 4px; margin-bottom: 4px;">
                                <span style="font-size: 0.875rem; color: #374151;">${doc.name}</span>
                                <button type="button" onclick="removeLeaseDocument(${idx})" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 2px; font-size: 16px;">√ó</button>
                            </div>
                        `;
                    });
                    leaseFilesHtml += '</div>';
                    leaseDisplay.innerHTML = leaseFilesHtml;
                } else {
                    leaseDisplay.innerHTML = '<span style="color: #64748b;">No documents uploaded</span>';
                }
                
                // Update upload button state
                const uploadBtn = document.getElementById('leaseUploadBtn');
                if (tenant.leaseDocuments.length < 3) {
                    uploadBtn.disabled = false;
                    uploadBtn.style.opacity = '1';
                    uploadBtn.style.cursor = 'pointer';
                    uploadBtn.textContent = 'Upload';
                }
                
                showNotification('Lease document removed. Save tenant to apply changes.');
            }
        }

        // Update addTenant function to handle different document modes
        function processIdDocuments(existingIdDocuments, existingIdDocument, newFiles) {
            if (window.idDocumentMode === 'add') {
                // Add more mode: keep existing and add new
                const combined = existingIdDocuments ? [...existingIdDocuments] : [];
                if (existingIdDocument && !existingIdDocuments) {
                    // Convert old single format to array
                    combined.push(existingIdDocument);
                }
                
                // Add new files
                for (let file of newFiles) {
                    combined.push({
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        lastModified: file.lastModified
                    });
                }
                return combined;
            } else {
                // Replace mode: replace all with new files
                const result = [];
                for (let file of newFiles) {
                    result.push({
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        lastModified: file.lastModified
                    });
                }
                return result;
            }
        }

        // Make functions globally available (must be after all function definitions)
        window.showTab = showTab;
        window.deleteTenant = deleteTenant;
        window.deleteMonthly = deleteMonthly;
        window.deleteExpense = deleteExpense;
        window.deleteMoveOut = deleteMoveOut;
        window.removeLeaseDocument = removeLeaseDocument;
        window.removeIdDocument = removeIdDocument;
        window.removeSingleIdDocument = removeSingleIdDocument;
        window.removeNewFile = removeNewFile;
        window.removeNewLeaseFile = removeNewLeaseFile;
        window.installApp = window.installApp;
        window.exportData = exportData;
        window.exportCSV = exportCSV;
        window.importData = importData;
        window.clearAllData = clearAllData;
        window.editTenant = editTenant;
        window.editMonthly = editMonthly;
        window.editExpense = editExpense;
        window.editMoveOut = editMoveOut;
        window.cancelMonthlyEdit = cancelMonthlyEdit;
        window.cancelExpenseEdit = cancelExpenseEdit;
        window.cancelMoveOutEdit = cancelMoveOutEdit;
        window.loginWithGoogle = loginWithGoogle;
        window.logoutUser = logoutUser;
    </script>
</body>
</html>
